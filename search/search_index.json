{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"]},"docs":[{"location":"","title":"About","text":"<p>GitGud Security Notes is an information security knowledge base made from bunch of infosec stuff I read and compile when I have the will power. GitGud Security Notes will hopefully help you Git Gud on Security topics.</p> <p>Due to the my workflow, these are to be expected:</p> <ul> <li>stub article, broken link, etc. Since not all locally stored notes are hosted here</li> <li>unclear source/ references. This was essentially a personal notes and references might not be very good.</li> </ul> <p>These issues, in due time, will be fixed - but my take a while since this is a side project.</p>"},{"location":"#workflow","title":"Workflow","text":"<p>Currently I use obsidian, but have just moved from notion, so a bunch of notes is missing and/or still in process of moving. In general this is the workflow<sup>1</sup> for GitGudSec Notes:</p> <pre><code>graph TD\n\nfeedly --&gt; raindrop\nsocmed[twitter/mastdn/bsky]  --&gt; raindrop\nraindrop --&gt; | summarize | compendiums[local KB] \ntry[tinker, experience] --&gt; compendiums \ncompendiums --&gt; | fix markdown | gg.aldosimon.com</code></pre>"},{"location":"#contact","title":"Contact","text":"<p>I can be contacted on my blog aldosimon.com</p> <ol> <li> <p>inspired by this glorious note taking article \u21a9</p> </li> </ol>"},{"location":"amazon-vpc-log/","title":"Related notes and references","text":"<p>aws-detect-and-response</p>"},{"location":"amazon-vpc-log/#amazon-vpc","title":"Amazon VPC","text":"<p>Amazon-VPC (Virtual Private Cloud) provides AWS customers a logically isolated section of Amazon Web Services Cloud. Allowing them to access the Amazon Elastic Compute Cloud over an IPsec based virtual private network.</p> <p>What does it log?  Amazon VPC records Network Flow Logs from across the Virtual Private Cloud. Flow log data for a monitored network interface is recorded as flow log records, which are log events consisting of fields that describe the traffic flow.</p> <p>Where does it log to? Amazon VPC can send logs to CloudWatch, S3 storage buckets and/or Kinesis firehose.</p> <p>How do I enable it? VPC Flow logs are not enabled by default. To create a flow log, you must specify the resource for which to create the flow log, the type of traffic to capture and the destinations to which you want to publish the flow log data. AWS provides three guides on setting up VPC flow logs for S3, CloudWatch and FireHose. - [ ] research about firehouse</p> <p>How do I access the logs? To view flow logs, take o one of the following steps: - Open the Amazon EC2 console. In the navigation pane, choose Network Interfaces. Select the checkbox for the network interface. - Open the Amazon VPC console. In the navigation pane, choose Your VPCs. Select the checkbox for the VPC. - Open the Amazon VPC console. In the navigation pane, choose Subnets. Select the checkbox for the subnet. Then choose Flow Logs.</p>"},{"location":"application-security/","title":"about","text":""},{"location":"application-security/#appsec-program-bsidessf-2020-how-to-10x-your-companys-security-clint-gibbler","title":"AppSec program BSidesSF 2020 - How to 10X Your Company\u2019s Security - clint gibbler","text":""},{"location":"application-security/#principals","title":"principals","text":"<ul> <li>automate as much as possible</li> <li>guardrails not gatekeeping</li> <li>high signal low noise tools and alerting: okay not to catch everything, but when it catch something, it is impactful</li> <li>developers are security customer: <ul> <li>make secure with less friction</li> </ul> </li> <li>self service security<ul> <li>tools and service that user can use with less security team interaction</li> </ul> </li> </ul>"},{"location":"application-security/#app-security-program","title":"app-security-program","text":""},{"location":"application-security/#fundamentals-short-term","title":"fundamentals (short-term)","text":"<p>Vulnerability Management Continuous Scanning Asset Inventory:      - code, cloud (compute, services, secrets, api, roles, network acl), database, network endpoint, endpoint     - which RDS without encryption, which compute endpoint is exposed to internet</p>"},{"location":"application-security/#scaling-medium-term","title":"scaling (medium-term)","text":"<p>threat modeling: focus effort on risk, determine risk with developer help     - self service security questioner for developer     - light weight threat model inside SDLC security engineering: build framework, library, templates that are secure by default detection and response:     - when fishy events occurs, send alert to dev. escalate if user did not initiate action.     - another POV is automating SOC runbook</p>"},{"location":"application-security/#long-term","title":"long-term","text":"<p>automate least privilege     - policy_sentry, repokid targeting vuln class      -time audit, use result to focus on certain vuln class by secure default enforce invariants: enforce/ alert on things that should always or never be true. idea is if there is no need for context (these things should always or never), no need for sec team time      - ec2 should never open all port to public -&gt; enforce with lambda      - manual changes should never be made through aws console -&gt; detect with cloudtrail      - never spin up instance in x regions -&gt; detect/ enforce</p>"},{"location":"application-security/#reference-and-related","title":"reference-and-related","text":"<p>[[infosec-compendiums|infosec-compendiums]]</p>"},{"location":"aws-detect-and-response/","title":"AWS detect and response","text":"","tags":["detect","response","AWS"]},{"location":"aws-detect-and-response/#prepare","title":"prepare","text":"","tags":["detect","response","AWS"]},{"location":"aws-detect-and-response/#logging","title":"logging","text":"<p>Variety of service that relate to AWS logging:</p> <p>guardduty cloudtrail ec2-logs amazon-vpc-log lambda-log cloudfront log rds-log cloudwatch</p>","tags":["detect","response","AWS"]},{"location":"aws-detect-and-response/#security-account","title":"security-account","text":"<p>security account - Have a Security Account, as per AWS best practice Creating an AWS Security Account - Chris Farris. Does the security account have audit capability to the environment? - Have an responder role account, with permission to run containment actions aws IR - Do not use these account for security engineering activities</p> <p>Security Contact</p> <ul> <li>AWS will send critical abuse and security notices to the root email address on the account. So establish a cloudsecurity-alerts distribution list for your company and set that as the Security Contact in all your AWS Accounts.. or Build that via API, and\u00a0Chris Farris Script.</li> <li>read up on AWS support playbook aws help</li> </ul>","tags":["detect","response","AWS"]},{"location":"aws-detect-and-response/#asset-inventory","title":"asset-inventory","text":"<p>You must have the ability to view you asset inventory. is the asset prod/ testing? is there any PII? contact person for the asset? All of this is the critical business context that AWS cannot provide. Incident Response in AWS - Chris Farris</p> <p>chris have a script to pull using steampipe.io and send to splunk</p> <ul> <li>[ ] put the script that list asset in AWS\u23eb into steampipe collection </li> </ul>","tags":["detect","response","AWS"]},{"location":"aws-detect-and-response/#correlate","title":"correlate","text":"<p>You must have the ability to search  and correlate AWS logs, on-prem, VPN logs, SSO logs, etc. This usually comes in a form of SIEM, or log management.</p> <p>There are myriads of way of doing SIEM and AWS, one from Chris Farris :</p> <pre><code>graph TD\n\nCloudTrail --&gt; S3 --&gt; AWS_SQS --&gt; SIEM\nGuardDuty --&gt; EventBridge --&gt; Lambda --&gt; SIEM\nCMDB/steampipe --&gt; SIEM\nSIEM --&gt; AWS_Detective\nSIEM --&gt; Analyst\nAWS_Detective --&gt; Analyst\nOtherLog/VPN/SSO --&gt; SIEM</code></pre>","tags":["detect","response","AWS"]},{"location":"aws-detect-and-response/#other-tooling","title":"other-tooling","text":"<ul> <li>VPC FlowLogs will help you understand the network plane stuff. Who is coming and going from your castle?</li> <li>Preparing to conduct an EC2 or Container forensic operation is best done before you need to do that.</li> <li>Detective is a managed capability from AWS to help you understand and investigate events, but it\u2019s pretty expensive. This is useful if you don\u2019t already have the tooling to help</li> <li>[ ] learn more about AWS detective\u23eb </li> <li>Macie is great for finding the PII in your environment. Chris Farris Macie.</li> </ul>","tags":["detect","response","AWS"]},{"location":"aws-detect-and-response/#detect-analysis","title":"detect-analysis","text":"<p>Incident Response in AWS - Chris Farris start with: <pre><code>index=\"aws_cloudtrail\" \"i-086c8727e55bb6d68\"\nreadOnly=false\n| table eventName, eventSource, userIdentity.arn, sourceIPAddress\n</code></pre></p> <p>then move to chosen ARN or IP or resources</p> <pre><code>index=\"aws_cloudtrail\" userIdentity.arn=arn:aws:sts::759429568549:assumed-role/Developer/* \n| table eventName, eventSource, sourceIPAddress\n</code></pre>","tags":["detect","response","AWS"]},{"location":"aws-detect-and-response/#a-high-level-flowchart-of-detect-and-analysis","title":"A high level flowchart of detect and analysis","text":"<pre><code>flowchart TD\n\n\u00a0 \u00a0 A[Event] --&gt; B[what the event about?]\n\n    B --&gt; |Resources| C[investigate resources]\n\n\u00a0 \u00a0 B --&gt; |Identity| D[investigate identity]\n\n\u00a0 \u00a0 B --&gt; |IP| Y[investigate IP]\n\n\u00a0 \u00a0 C --&gt; E[who created the resources]\n\n\u00a0 \u00a0 E --&gt; F[delete resources]\n\n\u00a0 \u00a0 E --&gt; D\n\n\u00a0 \u00a0 D --&gt; G[what action identity did]\n\n\u00a0 \u00a0 G --&gt; H[identity create resources?]\n\n\u00a0 \u00a0 H --&gt; |Yes| F\n\n\u00a0 \u00a0 G --&gt; I[identity pivot or create identity]\n\n\u00a0 \u00a0 I --&gt; D\n\n\u00a0 \u00a0 Y --&gt; J[do other identity using this IP]\n\n\u00a0 \u00a0 J --&gt; D\n\n\u00a0 \u00a0 D --&gt; K[do identity use other IP]\n\n\u00a0 \u00a0 K --&gt; Y</code></pre> <p>read more on ARN here:  AWS ARN Explained Amazon Resource Name Guide</p> <ul> <li>[ ] put this on a guide\u23eb </li> </ul>","tags":["detect","response","AWS"]},{"location":"aws-detect-and-response/#lateral-movement","title":"Lateral Movement","text":"<p>Movement can be cloud to cloud (AssumeRole), cloud to ground (EC2/ Compute Engine), or ground to cloud see more on cloud-detection-catalogue</p> <p>lateral movement query example</p> <pre><code>index=cloudtrail eventName=AssumeRole OR StartSession OR SendCommand OR SendSSHPublicKey \n| stats count by eventName, userIdentity.arn, sourceIPAddress\n</code></pre> <ul> <li>[ ] read and try\ud83d\udd3c lateral movement: Lateral movement risks in the cloud and how to prevent them \u2013 Part 1 the network layer (VPC)  Wiz Blog EC2-Instance-Connect Lateral Movement Strategy for Data Exfiltration How to Compromise AWS Using the Metadata Service - risk3sixty 1</li> </ul>","tags":["detect","response","AWS"]},{"location":"aws-detect-and-response/#identify-initial-access","title":"Identify initial access","text":"<p>One key thing you\u2019ll need to do as part of containment is to figure out how they got in in the first place. If it was leaked keys to GitHub, that\u2019s easy. If attacker exfiltrated the credentials from an EC2 instance or container due to an application issue, that will be a bit harder to find. </p> <p>With EC2 Instance Roles, the Instance ID is part of the Role Session Name, which may help you.</p> <p>But if you can\u2019t find the initial vector, you\u2019ll play wack-a-mole with containment, or you\u2019ll have to be more impactful with the containment policies you apply. This is one reason that best-practice is to have one role per resource or app (the other is to maintain least-privilege).</p>","tags":["detect","response","AWS"]},{"location":"aws-detect-and-response/#containment-and-eradication","title":"Containment and Eradication","text":"","tags":["detect","response","AWS"]},{"location":"aws-detect-and-response/#access-key","title":"Access Key","text":"","tags":["detect","response","AWS"]},{"location":"aws-detect-and-response/#disable-access-key","title":"Disable Access Key","text":"<p>The Quarantine Policy isn\u2019t enough. You want to disable the key ASAP! Note: you want to disable the key, don\u2019t delete it. You may not know the service impact of disabling the key at the outset of the incident. You may need to re-enable it to recover from a service impact.</p> <p>responder role should have this permission </p> <p></p>","tags":["detect","response","AWS"]},{"location":"aws-detect-and-response/#revoke-active-session","title":"Revoke Active Session","text":"<p>Temporary credentials that Lambda, EC2 Instances, and Containers use, you need to invalidate the compromised credentials. Via the AWS console, you can say, \u201cDeny everything for all sessions created before X date-time\u201d. remember that: attackers may be able to use the same exploit again if you don't know initial access.</p> <p></p>","tags":["detect","response","AWS"]},{"location":"aws-detect-and-response/#deny-policy","title":"Deny Policy","text":"<p>Based on your needs, either deny everything (broke Prod) or pick allow with developer help.</p> <pre><code>  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Effect\": \"Deny\",\n      \"Action\": [\"*\"],\n      \"Resource\": [\"*\"]\n    }\n  ]\n}\n</code></pre> <pre><code>{ \"Version\": \"2012-10-17\", \n\"Statement\": [ \n        { \n        \"Effect\": \"Deny\", \n        \"NotAction\": [\"THINGS YOU NEED\"], \n        \"Resource\": [\"*\"] \n        } \n    ] \n}\n</code></pre>","tags":["detect","response","AWS"]},{"location":"aws-detect-and-response/#apply-ip-address-condition","title":"Apply IP Address Condition","text":"<p>Another alternative is to limit the use of the credentials to a handful of known and trusted IP addresses. This can reduce the service impact while also limiting your attacker\u2019s ability to use the credentials.</p> <pre><code>{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Effect\": \"Deny\",\n      \"Action\": [\"*\"],\n      \"Resource\": [\"*\"],\n      \"Condition\": {\n        \"Bool\": {\"aws:ViaAWSService\": \"false\"},\n        \"NotIpAddress\": {\n          \"aws:SourceIp\": [\"192.0.2.0/24\",\"203.0.113.19/32\"]\n        }\n      }\n    }\n  ]\n}\n</code></pre>","tags":["detect","response","AWS"]},{"location":"aws-detect-and-response/#note-about-containment-with-security-groups","title":"Note about containment with security groups","text":"<p>containing connection using security group do not cut currently up connection connection tracking source containment - [ ] read more on source containment in lieu of connection tracking\ud83d\udd3c .</p>","tags":["detect","response","AWS"]},{"location":"aws-detect-and-response/#note-about-containment-from-dns-route-53","title":"Note about containment from DNS route 53","text":"<p>Security Groups and Network ACLs do not filter traffic to Amazon Route 53. When containing an EC2 instance, if you want to prevent it from contacting external hosts, ensure you also explicitly block DNS communications. source containment</p>","tags":["detect","response","AWS"]},{"location":"aws-detect-and-response/#data-breach","title":"data-breach","text":"<p>Is there any data breach would be the main question on incident. how can you tell if they got your data? You may see a ListBuckets eventName, but that is not proof of any data exfiltration.</p> <p>The alternative of GetObject is availble when you enable data event, </p>","tags":["detect","response","AWS"]},{"location":"aws-detect-and-response/#containment-tooling","title":"Containment tooling","text":"<p>AWS containment automation - [ ] to read and test this aws containment automation, also add other tools\ud83d\udd3c </p>","tags":["detect","response","AWS"]},{"location":"aws-detect-and-response/#detect-response-playbooks","title":"detect-response-playbooks","text":"","tags":["detect","response","AWS"]},{"location":"aws-detect-and-response/#vpc","title":"vpc","text":"<p>aws vpc analysis</p>","tags":["detect","response","AWS"]},{"location":"aws-detect-and-response/#iam","title":"iam","text":"<p>compromisedIAM</p>","tags":["detect","response","AWS"]},{"location":"aws-detect-and-response/#rds","title":"rds","text":"<p>public rds</p>","tags":["detect","response","AWS"]},{"location":"aws-detect-and-response/#s3","title":"s3","text":"<p>s3 ransom response s3 public access</p>","tags":["detect","response","AWS"]},{"location":"aws-detect-and-response/#reference-related","title":"reference-related","text":"<p>aws IR AWS playbook hackingthe.cloud guardduty cloudtrail ec2-logs amazon-vpc-log lambda-log cloudfront log rds-log cloudwatch - [ ] read more on aws IR playbook \ud83d\udd3a </p>","tags":["detect","response","AWS"]},{"location":"aws-detection-catalogue/","title":"AWS Detection Catalogue","text":"<p>This page list common AWS API calls (cloudtrail) and tries to map (loosely) them to MITRE ATTACK framework. If you are hunting or handling incidents, these can be your starting points.  These list are collected from various article listed below.</p>","tags":["cloudsec","TTP"]},{"location":"aws-detection-catalogue/#initial-access","title":"Initial Access","text":"","tags":["cloudsec","TTP"]},{"location":"aws-detection-catalogue/#key-cloudtrail","title":"Key Cloudtrail","text":"<ul> <li><code>ConsoleLogin</code>\u00a0- Interactive AWS console access</li> <li><code>PasswordRecoveryRequested</code>\u00a0- Password reset attempts</li> <li><code>AssumeRoleWithWebIdentity</code>\u00a0- Federated authentication abuse</li> <li><code>GetSessionToken</code>\u00a0- Temporary credential requests</li> </ul>","tags":["cloudsec","TTP"]},{"location":"aws-detection-catalogue/#detection-examples","title":"Detection Examples","text":"<pre><code>SELECT eventTime, sourceIPAddress, userIdentity.userName, errorCode, errorMessage  \nFROM cloudtrail_logs  \nWHERE eventName = 'ConsoleLogin'  \nAND errorCode IN ('SigninFailure', 'Failed authentication')  \nAND eventTime &gt; NOW() - INTERVAL '1 hour'  \nGROUP BY sourceIPAddress  \nHAVING COUNT(*) &gt; 5;\n</code></pre>","tags":["cloudsec","TTP"]},{"location":"aws-detection-catalogue/#execution","title":"Execution","text":"","tags":["cloudsec","TTP"]},{"location":"aws-detection-catalogue/#key-cloudtrail_1","title":"Key Cloudtrail","text":"<ul> <li><code>StartInstance</code>\u00a0/\u00a0<code>StartInstances</code>\u00a0- EC2 instance execution</li> <li><code>Invoke</code>\u00a0- Lambda function execution</li> <li><code>SendCommand</code>\u00a0- Systems Manager command execution</li> <li><code>RunInstances</code>\u00a0- New EC2 instance creation</li> </ul>","tags":["cloudsec","TTP"]},{"location":"aws-detection-catalogue/#detection-examples_1","title":"Detection Examples","text":"<pre><code>-- Monitor SSM command execution  \nSELECT eventTime, userIdentity.userName, requestParameters.instanceIds,   \n       requestParameters.parameters.commands  \nFROM cloudtrail_logs   \nWHERE eventName = 'SendCommand'  \n  AND requestParameters.parameters.commands LIKE '%curl%'  \n  AND requestParameters.parameters.commands LIKE '%bash%';\n</code></pre>","tags":["cloudsec","TTP"]},{"location":"aws-detection-catalogue/#enumeration-discovery","title":"Enumeration/ Discovery","text":"","tags":["cloudsec","TTP"]},{"location":"aws-detection-catalogue/#key-cloudtrail_2","title":"Key Cloudtrail","text":"<ul> <li>ec2:DescribeInstances<ul> <li>Describes the specified instances or all instances \"What type of EC2 infrastructure is present in this account?\" one of the way to do it: account id from ec2</li> </ul> </li> <li>s3:ListObjects - Ransomware in AWS S3 SSE-C#Explaining the S3 SSE-C Ransomware Approach<ul> <li>[ ] research and complete this block</li> </ul> </li> <li>`ListSSHPublicKeys </li> <li><code>SimulatePrincipalPolicy</code>: The AWS Policy Simulator allows users to test an existing policy recorded in the\u00a0policySourceArn\u00a0field against a set of actions recorded in the\u00a0actionNames\u00a0field. This helps answer the question can I perform action X with policy Y.</li> <li><code>ListUsers</code>\u00a0- IAM user enumeration</li> <li><code>ListRoles</code>\u00a0- IAM role enumeration</li> <li><code>ListIdentities</code>\u00a0- SES identity listing</li> <li><code>ListAccessKeys</code>\u00a0- Access key discovery</li> <li><code>ListServiceQuotas</code>\u00a0- Service limit discovery</li> <li><code>ListInstanceProfiles</code>\u00a0- EC2 service role discovery</li> <li><code>ListBuckets</code>\u00a0- S3 bucket enumeration</li> <li><code>ListGroups</code>\u00a0- IAM group discovery</li> <li><code>GetSendQuota</code>\u00a0- SES sending limits</li> <li><code>GetCallerIdentity</code>\u00a0- Current identity verification</li> <li><code>DescribeInstances</code>\u00a0- EC2 instance discovery</li> <li><code>GetBucketAcl</code>\u00a0- S3 permissions discovery</li> <li><code>GetBucketVersioning</code>\u00a0- S3 versioning status</li> <li><code>GetAccountAuthorizationDetails</code>\u00a0- Comprehensive account enumeration</li> <li>From - Following attackers\u2019 (Cloud)trail in AWS Methodology and findings in the wild   Datadog Security Labs</li> </ul> Enumeration API call Comment Attacker's question being answered <code>sts:GetCallerIdentity</code> Returns the identity of the authenticated user \"What are the credentials I compromised?\" <code>ses:GetAccount</code> Returns information about the SES account, including sending limits and past usage \"What's the volume of emails I can send through this account?\" <code>ses:GetSendQuota</code> Returns SES sending limits \"What's the volume of emails I can send through this account?\" <code>ses:ListIdentities</code> Lists verified SES senders \"Who can I impersonate?\" <code>sns:GetSMSAttributes</code> Returns SMS sending settings \"What's the SMS monthly spend limit?\" <code>iam:ListUsers</code> Returns IAM users in the account \"How many people are using this account?\" <code>ec2:DescribeRegions</code> Describes the Regions that are enabled for your account, or all Regions. \"What regions are enabled that infrastructure could be set up in?\" <code>ec2:DescribeInstances</code> Describes the specified instances or all instances \"What type of EC2 infrastructure is present in this account?\" <code>ec2:DescribeVpcs</code> Describes one or more of your VPCs \"How is the network infrastructure set up in this account?\" <code>lightsail:GetRegions</code> Returns a list of all valid regions for Amazon Lightsail \"What regions are enabled that infrastructure could be set up in?\" <code>lightsail:GetInstances</code> Returns information about all Amazon Lightsail instances \"What type of Lightsail infrastructure is present in this account?\" <code>route53:ListDomains</code> Returns domain names registered in the account \"What's the name and domain names of the organization I have compromised?\" <code>route53:GetHostedZoneCount</code> Returns the number of hosted zones in the account \"How large is this company?\" <code>s3:ListBuckets</code> Returns S3 buckets \"Is there sensitive data available?\" <code>servicequotas:ListServiceQuotas</code> Returns service quotas in use for a specific service (e.g. EC2) \"How many resources can I spin up in that account?\"","tags":["cloudsec","TTP"]},{"location":"aws-detection-catalogue/#detection-examples_2","title":"Detection Examples","text":"<ul> <li>from Incident Response in AWS - Chris Farris <pre><code>index=cloudtrail eventName=GetCallerIdentity OR ListBuckets OR DescribeInstances \n| iplocation sourceIPAddress \n| table userIdentity.arn, sourceIPAddress, City, Country \n| sort -City, Country\n</code></pre></li> </ul> <pre><code>-- Identify reconnaissance activity  \nWITH discovery_events AS (  \n  SELECT eventTime, userIdentity.userName, sourceIPAddress, eventName  \n  FROM cloudtrail_logs   \n  WHERE eventName IN ('ListUsers', 'ListRoles', 'ListBuckets', 'DescribeInstances', 'GetCallerIdentity')  \n    AND eventTime &gt; NOW() - INTERVAL '1 hour'  \n)  \nSELECT userName, sourceIPAddress,   \n       COUNT(DISTINCT eventName) as unique_discovery_actions,  \n       COUNT(*) as total_discovery_calls  \nFROM discovery_events  \nGROUP BY userName, sourceIPAddress  \nHAVING COUNT(DISTINCT eventName) &gt; 5  \nORDER BY unique_discovery_actions DESC;\n</code></pre>","tags":["cloudsec","TTP"]},{"location":"aws-detection-catalogue/#persistence","title":"Persistence","text":"","tags":["cloudsec","TTP"]},{"location":"aws-detection-catalogue/#key-cloudtrail_3","title":"Key Cloudtrail","text":"<ul> <li><code>CreateAccessKey</code>\u00a0- New programmatic access credentials</li> <li><code>CreateUser</code>\u00a0- New IAM user creation</li> <li><code>CreateNetworkAclEntry</code>\u00a0- Network-level persistence</li> <li><code>CreateRoute</code>\u00a0- Routing table modifications</li> <li><code>CreateLoginProfile</code>\u00a0- Console access setup</li> <li><code>AuthorizeSecurityGroupEgress</code>\u00a0/\u00a0<code>AuthorizeSecurityGroupIngress</code>\u00a0- Firewall rule changes</li> <li><code>CreateVirtualMFADevice</code>\u00a0- MFA device setup</li> <li><code>CreateConnection</code>\u00a0- Database/service connections</li> <li>creation of a EC2 key pair, is known technique - Following attackers\u2019 (Cloud)trail in AWS Methodology and findings in the wild   Datadog Security Labs</li> <li>Creating root user - Following attackers\u2019 (Cloud)trail in AWS Methodology and findings in the wild   Datadog Security Labs</li> <li><code>create security group</code> - Following attackers\u2019 (Cloud)trail in AWS Methodology and findings in the wild   Datadog Security Labs</li> <li><code>CreateUser</code> from - The curious case of DangerDev@protonmail.me</li> <li><code>CreateLoginProfile</code>\u00a0call which is used to give a user the ability to login through the AWS management console from The curious case of DangerDev@protonmail.me</li> <li>Allow user to AssumeRole to a role that is privileged and preferably come from AWS default role. For example cat flap that allow user to AssumeRole for a <code>AWSControlTowerExecution</code> role.</li> </ul>","tags":["cloudsec","TTP"]},{"location":"aws-detection-catalogue/#detection-examples_3","title":"Detection Examples","text":"<p>from Incident Response in AWS - Chris Farris</p> <pre><code>index=cloudtrail\neventName=\"CreateUser\"\n| iplocation sourceIPAddress\n| search Country!=\"United States\"\n| table userIdentity.arn, sourceIPAddress,\n  City, Country\n</code></pre> <pre><code>-- Monitor user creation and access key generation  \nSELECT eventTime, userIdentity.userName, requestParameters.userName as new_user,  \n       responseElements.accessKey.accessKeyId  \nFROM cloudtrail_logs   \nWHERE eventName IN ('CreateUser', 'CreateAccessKey', 'CreateLoginProfile')  \n  AND userIdentity.type = 'IAMUser'  \nORDER BY eventTime DESC;\n</code></pre>","tags":["cloudsec","TTP"]},{"location":"aws-detection-catalogue/#privilege-escalation","title":"Privilege Escalation","text":"","tags":["cloudsec","TTP"]},{"location":"aws-detection-catalogue/#key-cloudtrail_4","title":"Key Cloudtrail","text":"<ul> <li>The\u00a0<code>AdministratorAccess</code>\u00a0policy was attached to the newly created account with\u00a0<code>AttachUserPolicy</code> that provides full access to AWS services and resources. </li> <li><code>AssumeRole</code> using external account from The curious case of DangerDev@protonmail.me. Attacker create malicious role, malicious role allows AssumeRole form external account.</li> <li><code>CreateGroup</code>\u00a0- Administrative group creation</li> <li><code>CreateRole</code>\u00a0- IAM role creation</li> <li><code>UpdateAccessKey</code>\u00a0- Access key status changes</li> <li><code>PutGroupPolicy</code>\u00a0- Inline group policy assignment</li> <li><code>PutRolePolicy</code>\u00a0- Inline role policy assignment</li> <li><code>PutUserPolicy</code>\u00a0- Inline user policy assignment</li> <li><code>AttachUserPolicy</code>\u00a0- Managed policy attachment to users</li> <li><code>AttachRolePolicy</code>\u00a0- Managed policy attachment to roles</li> <li><code>AddRoleToInstanceProfile</code>\u00a0- EC2 service role assignment</li> <li><code>AddUserToGroup</code>\u00a0- Group membership changes</li> <li> <p><code>PutAccountDetails</code></p> <p>read more: wiz</p> <p>Amazon Simple Email Service (SES) is AWS\u2019s cloud-based bulk email platform. By default, accounts operate in a restricted\u00a0\u201csandbox\u201d mode, where emails can only be sent to verified addresses and volumes are capped to 200 messages per day, at a maximum rate of one message per second. An account can be moved into the unrestricted \u201cproduction\u201d mode, in which emails can be sent to arbitrary recipients and the quota is raised, typically to 50,000 emails per day. The transition requires submitting account details for AWS review through the\u00a0<code>PutAccountDetails</code>\u00a0API, and customers who need even higher volumes can request additional capacity through a support ticket.</p> <p><code>CreateCase</code> was also used: </p> <p>But the attacker wasn\u2019t content with the default 50,000-emails-per-day quota. They tried to open a support ticket programmatically through the\u00a0<code>CreateCase</code>\u00a0API, asking AWS to further raise their limits\u00a0(ATT&amp;CK: T1098), an attempt that failed due to insufficient permissions</p> </li> <li> <p>Root access </p> <p>read more: Hands-On Security Tips For\u00a0Centralize Root Access\u00a0In AWS</p> <ol> <li>Monitor for New Permissions: Keep an eye out for any addition of permissions like\u00a0<code>sts:AssumeRoot</code>\u00a0to identities in your organization account. Any identity with this permission will be capable of assuming root access, which can pose a significant security risk.</li> <li>Attack Scenario \u2014 Re-Enabling Root Login: Imagine a scenario where an attacker knows the root password of a member account, but root login for that account has been disabled. If the attacker has already compromised a principal in the organization\u2019s AWS account that can assume root access (admittedly, an unusual situation), they might try to re-enable root login by using\u00a0<code>AssumeRoot</code>\u00a0with the\u00a0<code>IAMCreateRootUserPassword</code>\u00a0policy. They could then create a root login profile by assuming root privileges.</li> <li>Watch for Suspicious Actions: A compromised identity with permission to assume root access could create significant risks for member accounts by executing suspicious actions, such as\u00a0<code>aws iam create-login-profile</code>. To mitigate this risk, monitor any\u00a0<code>AssumeRoot</code>\u00a0actions with the\u00a0<code>IAMCreateRootUserPassword</code>\u00a0policy and closely watch for any root\u00a0<code>CreateLoginProfile</code>\u00a0actions within member accounts. Such actions are highly unusual and should always be investigated.</li> <li>Frequent\u00a0<code>**AssumeRoot**</code>\u00a0Logs: If you notice frequent\u00a0<code>AssumeRoot</code>\u00a0actions in your logs,\u00a0don't be alarmed right away. These actions are likely generated by CSPM tools that are verifying root configuration across all member accounts.</li> <li>[ ] research more on these detection opportunity of root access</li> </ol> </li> </ul>","tags":["cloudsec","TTP"]},{"location":"aws-detection-catalogue/#detection-examples_4","title":"Detection Examples","text":"<pre><code>-- Monitor privilege escalation activities  \nSELECT eventTime, userIdentity.userName, eventName,   \n       requestParameters.groupName, requestParameters.roleName,  \n       requestParameters.policyDocument, requestParameters.policyArn  \nFROM cloudtrail_logs   \nWHERE eventName IN ('PutUserPolicy', 'PutRolePolicy', 'PutGroupPolicy', 'AttachUserPolicy', 'AttachRolePolicy', 'AddUserToGroup')  \n  AND (requestParameters.policyDocument LIKE '%\"*\"%'   \n       OR requestParameters.policyArn LIKE '%AdministratorAccess%'  \n       OR requestParameters.policyArn LIKE '%PowerUserAccess%'  \n       OR requestParameters.groupName LIKE '%Admin%'  \n       OR requestParameters.groupName LIKE '%Power%');\n</code></pre>","tags":["cloudsec","TTP"]},{"location":"aws-detection-catalogue/#defense-evasion","title":"Defense Evasion","text":"","tags":["cloudsec","TTP"]},{"location":"aws-detection-catalogue/#key-cloudtrail_5","title":"Key Cloudtrail","text":"<ul> <li><code>StopLogging</code>\u00a0- CloudTrail logging disruption</li> <li><code>DeleteTrail</code>\u00a0- Audit trail removal</li> <li><code>UpdateTrail</code>\u00a0- Audit configuration changes</li> <li><code>PutEventSelectors</code>\u00a0- Logging scope modification</li> <li><code>DeleteFlowLogs</code>\u00a0- VPC flow log removal</li> <li><code>DeleteDetector</code>\u00a0- GuardDuty detector deletion</li> <li><code>DeleteMembers</code>\u00a0- Security service membership removal</li> <li><code>DeleteSnapshot</code>\u00a0- Evidence destruction</li> <li><code>DeactivateMFADevice</code>\u00a0- MFA bypass</li> <li><code>DeleteCertificate</code>\u00a0- SSL certificate removal</li> <li>Removing IAM users with\u00a0<code>DeleteUser</code></li> <li>Cleaning up policies with <code>DetachUserPolicy</code> and\u00a0<code>DeleteUserPolicy</code></li> <li>Deactivating long term access keys with\u00a0<code>UpdateAccessKey</code></li> <li>Cleaning up long term access keys with\u00a0<code>DeleteAccessKey</code></li> <li>Inspecting GuardDuty findings with <code>ListFindings</code> and\u00a0<code>GetFindings</code> this is unique because Amazon Relational Database Service (RDS) console is used RDSDBinstance to access GuardDuty</li> <li>For GuardDuty <code>DeleteDetector</code> <code>UpdateDetector</code> <code>CreateIPSet</code> are nice events to look at. The first two have explicit names but the last one can be trickier and forgotten. This event allows monitoring when someone is updating the list of the GuardDuty trusted IP addresses. An attacker can use this to whitelist its C2\u2019s IP addresses to avoid detection</li> </ul>","tags":["cloudsec","TTP"]},{"location":"aws-detection-catalogue/#detection-examples_5","title":"Detection Examples","text":"<pre><code>-- Monitor security control tampering  \nSELECT eventTime, userIdentity.userName, eventName, requestParameters.name,  \n       requestParameters.detectorId, requestParameters.trailName  \nFROM cloudtrail_logs   \nWHERE eventName IN ('StopLogging', 'DeleteTrail', 'DeleteDetector', 'DeleteFlowLogs')  \n  AND userIdentity.type != 'AWSService'  \nORDER BY eventTime DESC;\n</code></pre> <pre><code>index=cloudtrail \neventName=StopLogging OR DeleteTrail OR PutEventSelectors OR DeleteDetector\n| iplocation sourceIPAddress \n| table userIdentity.arn, sourceIPAddress, City, Country\n</code></pre>","tags":["cloudsec","TTP"]},{"location":"aws-detection-catalogue/#credential-access","title":"Credential Access","text":"","tags":["cloudsec","TTP"]},{"location":"aws-detection-catalogue/#key-cloudtrail_6","title":"Key Cloudtrail","text":"<p><code>GetSecretValue</code>\u00a0- Secrets Manager access <code>PutSecretValue</code>\u00a0- Secrets modification <code>CreateSecret</code>\u00a0- New secret creation <code>DeleteSecret</code>\u00a0- Secret removal <code>GetPasswordData</code>\u00a0- EC2 Windows password retrieval <code>RequestCertificate</code>\u00a0- SSL certificate requests <code>UpdateAssumeRolePolicy</code>\u00a0- Trust relationship changes</p>","tags":["cloudsec","TTP"]},{"location":"aws-detection-catalogue/#detection-examples_6","title":"Detection Examples","text":"<pre><code>-- Monitor credential access patterns  \nSELECT eventTime, userIdentity.userName, requestParameters.secretId,  \n       requestParameters.instanceId, sourceIPAddress  \nFROM cloudtrail_logs   \nWHERE eventName IN ('GetSecretValue', 'PutSecretValue', 'CreateSecret', 'DeleteSecret', 'GetPasswordData')  \n  AND eventTime &gt; NOW() - INTERVAL '24 hours'  \nGROUP BY userIdentity.userName, sourceIPAddress  \nHAVING COUNT(*) &gt; 10;\n</code></pre>","tags":["cloudsec","TTP"]},{"location":"aws-detection-catalogue/#impact","title":"Impact","text":"","tags":["cloudsec","TTP"]},{"location":"aws-detection-catalogue/#key-cloudtrail_7","title":"Key Cloudtrail","text":"<ul> <li><code>s3:PutObject</code></li> <li><code>s3:GetObject</code></li> <li>s3 cp / <code>CopyObject</code> </li> </ul> <p>Creates a copy of an object that is already stored in Amazon S3. this is used in where ransomware operator encrypt S3 using own key (SSE-C). You can copy individual objects between general purpose buckets, between directory buckets, and between general purpose buckets and directory buckets. Both the Region that you want to copy the object from and the Region that you want to copy the object to must be enabled for your account.</p> <pre><code>--command used\naws s3 cp s3://&lt;bucket_with_data&gt;/&lt;file_name&gt; s3://&lt;bucket_with_data&gt;/&lt;file_name&gt; \\\n--sse-c AES256 \\\n--sse-c-key &lt;customer_provided_key_here&gt; \n</code></pre> <ul> <li><code>PutBucketVersioning</code>\u00a0- S3 versioning manipulation</li> <li><code>DeleteObject</code>\u00a0- S3 object deletion</li> <li><code>RunInstances</code>\u00a0- Resource creation for impact</li> <li><code>DeleteAccountPublicAccessBlock</code>\u00a0- S3 public access enabling</li> <li><code>DeleteDBInstance</code>\u00a0- Database deletion</li> <li><code>ModifyDBInstance</code>\u00a0- Database modification</li> <li><code>s3:DeleteObjectVersion</code></li> <li><code>s3:PutLifecycleConfiguration</code>  ransomware operator used to auto delete after a certain time</li> </ul>","tags":["cloudsec","TTP"]},{"location":"aws-detection-catalogue/#detection-examples_7","title":"Detection Examples","text":"<pre><code>-- Monitor high-impact activities  \nSELECT eventTime, userIdentity.userName, eventName,  \n       requestParameters.instanceType, requestParameters.minCount,  \n       requestParameters.versioningConfiguration, requestParameters.bucketName,  \n       requestParameters.dbInstanceIdentifier  \nFROM cloudtrail_logs   \nWHERE (eventName = 'RunInstances' AND requestParameters.instanceType IN ('c5.xlarge', 'c5.2xlarge', 'c5.4xlarge'))  \n   OR (eventName = 'PutBucketVersioning' AND requestParameters.versioningConfiguration LIKE '%Suspended%')  \n   OR eventName = 'DeleteAccountPublicAccessBlock'  \n   OR eventName = 'DeleteObject'  \n   OR eventName = 'DeleteDBInstance'  \nORDER BY eventTime DESC;\n</code></pre>","tags":["cloudsec","TTP"]},{"location":"aws-detection-catalogue/#lateral-movement","title":"Lateral Movement","text":"","tags":["cloudsec","TTP"]},{"location":"aws-detection-catalogue/#key-cloudtrail_8","title":"Key Cloudtrail","text":"<ul> <li>sts:AssumeRole (Cloud to Cloud) -- Role assumption for lateral access</li> <li>ssm:StartSession (Cloud to Ground)</li> <li>ssm:SendCommand (Cloud to Ground)</li> <li>ec2-instance-connect:SendSSHPublicKey (Cloud to Ground)</li> <li>ec2:AuthorizeSecurityGroupIngress (Cloud to Ground, or Ground to Ground)</li> <li>VPC Flow Logs (Ground to Ground)</li> <li><code>SwitchRole</code>\u00a0- Console role switching</li> </ul>","tags":["cloudsec","TTP"]},{"location":"aws-detection-catalogue/#detection-examples_8","title":"Detection Examples","text":"<pre><code>-- Monitor cross-account access  \nSELECT eventTime, userIdentity.arn, requestParameters.roleArn,  \n       requestParameters.roleSessionName, sourceIPAddress  \nFROM cloudtrail_logs   \nWHERE eventName = 'AssumeRole'  \n  AND requestParameters.roleArn NOT LIKE '%:123456789012:%'  -- Your account ID  \nORDER BY eventTime DESC;\n</code></pre>","tags":["cloudsec","TTP"]},{"location":"aws-detection-catalogue/#exfiltration","title":"Exfiltration","text":"","tags":["cloudsec","TTP"]},{"location":"aws-detection-catalogue/#key-cloudtrail_9","title":"Key Cloudtrail","text":"<ul> <li><code>GetObject</code>\u00a0- S3 object retrieval</li> <li><code>CopyObject</code>\u00a0- S3 object copying</li> <li><code>CreateSnapshot</code>\u00a0- EBS snapshot creation</li> <li><code>ModifySnapshotAttributes</code>\u00a0- Snapshot sharing configuration</li> <li><code>ModifyImageAttribute</code>\u00a0- AMI sharing setup</li> <li><code>SharedSnapshotCopyInitiated</code>\u00a0- Cross-region snapshot copying</li> <li><code>SharedSnapshotVolumeCreated</code>\u00a0- Snapshot volume creation</li> <li><code>ModifyDBSnapshotAttribute</code>\u00a0- RDS snapshot sharing</li> <li><code>CreateDBSnapshot</code>\u00a0- Database snapshot creation</li> <li><code>PutBucketPolicy</code>\u00a0- S3 bucket policy modification</li> <li><code>PutBucketAcl</code>\u00a0- S3 bucket ACL changes</li> </ul>","tags":["cloudsec","TTP"]},{"location":"aws-detection-catalogue/#detection-examples_9","title":"Detection Examples","text":"<pre><code>-- Monitor data exfiltration activities  \nSELECT eventTime, userIdentity.userName, eventName,  \n       requestParameters.snapshotId, requestParameters.imageId,  \n       requestParameters.userIds, requestParameters.valuesToAdd,  \n       requestParameters.bucketName, requestParameters.key  \nFROM cloudtrail_logs   \nWHERE (eventName IN ('ModifySnapshotAttribute', 'ModifyImageAttribute', 'ModifyDBSnapshotAttribute')  \n       AND (requestParameters.userIds IS NOT NULL OR requestParameters.valuesToAdd IS NOT NULL))  \n   OR (eventName = 'GetObject' AND sourceIPAddress NOT LIKE '10.%' AND sourceIPAddress NOT LIKE '172.%' AND sourceIPAddress NOT LIKE '192.168.%')  \nORDER BY eventTime DESC;\n</code></pre>","tags":["cloudsec","TTP"]},{"location":"aws-detection-catalogue/#other","title":"Other","text":"","tags":["cloudsec","TTP"]},{"location":"aws-detection-catalogue/#anomalies","title":"Anomalies","text":"","tags":["cloudsec","TTP"]},{"location":"aws-detection-catalogue/#error-message-from-anomaly-ip","title":"Error message from anomaly IP","text":"<p>Incident Response in AWS - Chris Farris</p> <p><code>index=cloudtrail errorMessage=* | iplocation sourceIPAddress | stats count by City, Country | sort -City, Country</code></p>","tags":["cloudsec","TTP"]},{"location":"aws-detection-catalogue/#sensitive-iam-actions","title":"Sensitive IAM actions","text":"<p>why worry on a whole lot api calls, these are the most sensitive according to  sensitive iam  - CredentialExposure  - DataAccess  - PrivEsc  - ResourceExposure</p>","tags":["cloudsec","TTP"]},{"location":"aws-detection-catalogue/#references","title":"References","text":"<ol> <li>cloud-security</li> <li>sensitive iam </li> <li>cloudtrail cheatsheet</li> <li>The curious case of DangerDev@protonmail.me</li> <li>Following attackers\u2019 (Cloud)trail in AWS Methodology and findings in the wild   Datadog Security Labs</li> <li>Hands-On Security Tips For\u00a0Centralize Root Access\u00a0In AWS</li> <li>AWS Detection Engineering</li> <li>Chris Farris's AWS IR </li> <li>Ransomware in Amazon S3: SSE-C</li> </ol>","tags":["cloudsec","TTP"]},{"location":"aws-iam-quick-check/","title":"about","text":"<p>this guide how to do aws iam quick check, by first generating credential report and checking againts aws iam top 10</p>"},{"location":"aws-iam-quick-check/#generate-credential-report","title":"generate-credential-report","text":"<p>Recommended to do this periodically (via lambda). Generate credential report via CLI <pre><code>aws iam generate-credential-report\n</code></pre></p>"},{"location":"aws-iam-quick-check/#check-top-10","title":"check-top-10","text":""},{"location":"aws-iam-quick-check/#has-the-root-user-been-accessed-recently","title":"has the root user been accessed recently?","text":"<p>Check in 90 days period</p>"},{"location":"aws-iam-quick-check/#does-the-root-account-have-multi-factor-authentication-mfa-enabled","title":"Does the root account have multi-factor authentication (MFA) enabled?","text":""},{"location":"aws-iam-quick-check/#does-the-root-account-have-access-keys-enabled","title":"Does the root account have access keys enabled?","text":"<p>Root should not need access keys</p>"},{"location":"aws-iam-quick-check/#are-there-any-users-with-access-keys-and-console-credentials","title":"Are there any users with access keys and console credentials?","text":"<p>User should have either keys or console, but not both.</p>"},{"location":"aws-iam-quick-check/#check-for-inactive-users-and-users-that-have-never-logged-in","title":"Check for inactive users and users that have never logged in.","text":"<p>Find and delete any accounts where the users have passwords but have never logged in and accounts that haven't been used in last 90 days.</p>"},{"location":"aws-iam-quick-check/#find-any-users-with-passwords-that-have-not-been-rotated","title":"Find any users with passwords that have not been rotated","text":"<p>Match this period with your policy</p>"},{"location":"aws-iam-quick-check/#is-mfa-enabled-for-all-users","title":"Is MFA enabled for all users?","text":""},{"location":"aws-iam-quick-check/#are-access-keys-being-rotated","title":"Are access keys being rotated?","text":"<p>Match this period with your policy</p>"},{"location":"aws-iam-quick-check/#can-you-find-any-users-with-unused-access-keys","title":"Can you find any users with unused access keys?","text":"<p>Deactivate</p> <p>If you need a practical way of doing this, you can use steampipe, script is over here or here</p>"},{"location":"aws-iam-quick-check/#references-and-related-notes","title":"References and related notes","text":"<p>steampipe top 10 AWS IAM  aws-protect</p>"},{"location":"aws-protect/","title":"AWS Protect","text":"<p>is compiled notes, concept explanation about protecting your AWS assets there is no order to these notes, if you want step by step go here </p>","tags":["protect","AWS"]},{"location":"aws-protect/#aws-s3","title":"aws-s3","text":"","tags":["protect","AWS"]},{"location":"aws-protect/#s3-security-guidelines","title":"s3-security-guidelines","text":"<p>guidance and best practice - [ ] read up on aws s3 best practice\ud83d\udd3c  s3-best-practice s3-control-securityhub top-10 - Block public S3 buckets at the organization level - Use bucket policies to verify all access granted is restricted and specific - Ensure that any identity-based policies don\u2019t use wildcard actions - Enable S3 protection in GuardDuty to detect suspicious activities - Use Macie to scan for sensitive data outside of designated areas - Encrypt your data in S3 - Protect data in S3 from accidental deletion using S3 Versioning and S3 Object Lock - Enable logging for S3 using CloudTrail and S3 server access logging. also see cloudtrail, and s3-logging for comparison - Backup your data in S3 - Monitor S3 using Security Hub and CloudWatch Logs</p> <p>here is a practical guide on s3 protect, from ramimac-s3-logging 1. enforce IaaC (i.e. terraform), have standard modules for core services like S3.  2. For S3, you can configure your module to enable S3 Access Logs by default. Take care, as you\u2019ll need to handle each account:region pair where you will be hosting S3 buckets. 3. With your buckets represented as code, you can use a SAST tool or linter to: detect use of non hardened s3 bucket, detect when cloudtrail data events enabled. 4. on buckets with data events, write  detections for unapproved or unexpected access. 5. as mentioned above, S3 access log need lambda for detection (see here\u00a0a Lambda trigger\u00a0) for the bucket. The Lambda will need to parse the log file and implement detection logic over the logs. 6. use CSPM to enforce invariants</p> <p>using policy to protect from or scope down permission of IAM role from these action.  read on organizational-policy - <code>s3:DeleteObject</code> - <code>s3:DeleteObjectVersion</code> - <code>s3:PutLifecycleConfiguration</code> - <code>s3:PutObject</code> - <code>s3:GetObject</code> - <code>s3:PutLifecycleConfiguration</code> - <code>s3:ListObjects</code> - <code>s3:ListBuckets</code> (theorized)  - [ ] research public access blocks</p>","tags":["protect","AWS"]},{"location":"aws-protect/#bucket-policies","title":"bucket-policies","text":"<ul> <li>protect from SSE-C <ul> <li>deny object uploads with SSE-C\u00a0encryption</li> <li>denies non-KMS\u00a0(AWS\u00a0Managed Key or CMK)</li> <li>requires a specific CMK</li> </ul> </li> <li>[ ] read more on bucket policy vs s3 policy?</li> </ul>","tags":["protect","AWS"]},{"location":"aws-protect/#bucket-lifecycle","title":"bucket-lifecycle","text":"<ul> <li>[ ] read more on bucket lifecycle\ud83d\udd3c </li> </ul>","tags":["protect","AWS"]},{"location":"aws-protect/#block-public-access","title":"block-public-access","text":"<p>read more</p>","tags":["protect","AWS"]},{"location":"aws-protect/#s3-versioning","title":"s3-versioning","text":"<p>from slaw We can enable S3 versions, which keep versions of files as they are changed and deleted. The API call to delete a version is different than the one to delete a current object, so we can use IAM policies or SCPs to block version deletion.</p> <p>The problem is that gets a bit expensive. So we can use lifecycle policies to delete old versions, similar to how we will use it today to delete objects older than 90 days.</p> <p>Or if we\u00a0really\u00a0don\u2019t want to lose data, we can move it to AWS Glacier, very cheap storage which offers lock policies that prevent deletion for a set period of time. The downside of Glacier is that, depending on the storage class, it can take a day to get data back.</p>","tags":["protect","AWS"]},{"location":"aws-protect/#s3-logging","title":"s3-logging","text":"<p>also see cloudtrail - Only the management events/ control plane events. logging management events - however data events can be enabled. Here is how to log data events logging data events - There is also server log, to see request logs. It can only be configured with another S3 bucket as the target for log delivery.  - use event selector to specify <code>ReadOnly</code>\u00a0or\u00a0<code>WriteOnly</code> and advance event selector to specify<code>eventSource</code>,\u00a0<code>eventName</code>\u00a0and\u00a0<code>eventCategory</code> - set up the log using organization trail - guide to logging-s3-cloudtrail</p>","tags":["protect","AWS"]},{"location":"aws-protect/#s3-server-vs-cloudtrail-logging","title":"s3-server-vs-cloudtrail-logging","text":"<p>see here for comparison s3 server logging vs aws cloudtrail</p> Log properties AWS CloudTrail Amazon S3 server logs Can be forwarded to other systems (Amazon CloudWatch Logs, Amazon CloudWatch Events) Yes No Deliver logs to more than one destination (for example, send the same logs to two different buckets) Yes No Turn on logs for a subset of objects (prefix) Yes No Cross-account log delivery (target and source bucket owned by different accounts) Yes No Integrity validation of log file by using digital signature or hashing Yes No Default or choice of encryption for log files Yes No Object operations (by using Amazon S3 APIs) Yes Yes Bucket operations (by using Amazon S3 APIs) Yes Yes Searchable UI for logs Yes No Fields for Object Lock parameters, Amazon S3 Select properties for log records Yes No Fields for\u00a0<code>Object Size</code>,\u00a0<code>Total Time</code>,\u00a0<code>Turn-Around Time</code>, and\u00a0<code>HTTP Referer</code>\u00a0for log records No Yes Lifecycle transitions, expirations, restores No Yes Logging of keys in a batch delete operation No Yes Authentication failures1 No Yes Accounts where logs get delivered Bucket owner2, and requester Bucket owner only Performance and Cost AWS CloudTrail Amazon S3 Server Logs Price Management events (first delivery) are free; data events incur a fee, in addition to storage of logs No other cost in addition to storage of logs Speed of log delivery Data events every 5 minutes; management events every 15 minutes Within a few hours Log format JSON Log file with space-separated, newline-delimited records <p>or from rami mac guide on s3 logging</p> Data Events S3 Server Access Logs Support\u00a0granular Event Selectors Offer detail that is not available in Data Events, like\u00a0<code>HTTP Referer</code> N/A Log the Object Size and HTTP Referer Configured via Cloudtrail, and can easily be\u00a0managed centrally Have to be configured on each bucket Logs can be routed to various and multiple systems Can only log to another S3 bucket in the same region and account Reliable and ~fast delivery (under 5 minutes, often much sooner) Delivery is best effort and is \u201cwithin a few hours\u201d Generally, are well supported as a data source in your SIEM of choice Require a Lambda for detective controls, date partioning can enable querying (once enabled, post 2023) Cost per Data Event, for storage (both in AWS and your SIEM), and for SIEM ingestion (often) Cost for storage in S3 planning s3 logging <p>consider characteristics of each bucket: read/write volume expected; risk (unauthorized write/read); frequency of user access. Then, based on those parameters, go: - Turn on S3 Access Logs for any non-public bucket. Save them for a rainy day, at which point you can query them with Athena, somewhat painfully at scale - Use Cloudtrail Data Events with Event Selectors, on buckets of reasonable volume where you require detective controls on reads or writes - If you have a high volume bucket that needs detective controls, you\u2019ll want to deploy a Lambda to process S3 Access Logs as they\u2019re delivered - To actually allow querying of S3 Access Logs, invest in post processing</p>","tags":["protect","AWS"]},{"location":"aws-protect/#iam","title":"iam","text":"<p>also see AWS IAM quick check also see </p> <p>iam api call happens in N. Virginia.</p>","tags":["protect","AWS"]},{"location":"aws-protect/#understand-how-user-use-iam","title":"understand-how-user-use-iam","text":"<p>this should be one of the first step, understanding how user interact with aws services. after this then push to more secure route, by putting guardrail, not gate keeping.</p>","tags":["protect","AWS"]},{"location":"aws-protect/#less-static-long-term-creds","title":"less-static-long-term-creds","text":"<p>Access Keys in AWS\u00a0are typically tied to long-term credentials such as IAM\u00a0users. In AWS, security best practices recommend moving away from long-term credentials to short term credentials. Instead of\u00a0IAM\u00a0Users, IAM\u00a0roles are preferred. </p> <p>For more details about temporary credentials in AWS, AWS\u00a0has extensive documentation and AWS\u00a0STS. - [ ] research more on temp creds AWS</p>","tags":["protect","AWS"]},{"location":"aws-protect/#akia-asia","title":"AKIA-ASIA","text":"<p>IAM credentials with the\u00a0<code>AKIA</code>\u00a0prefix is long term access keys. These are associated with IAM users. These credentials can potentially be exposed and used by attackers, because they do not expire by default.</p> <p>IAM credentials with the\u00a0<code>ASIA</code>\u00a0prefix belong to short lived access keys which were generated using\u00a0STS. These credentials last for a limited time. </p>","tags":["protect","AWS"]},{"location":"aws-protect/#rotate-long-term-keys-to-minimize-exposure","title":"Rotate long-term keys to minimize exposure","text":"","tags":["protect","AWS"]},{"location":"aws-protect/#scan-code-for-stored-credentials-in-cicd-pipelines-and-repositories","title":"Scan code for stored credentials in CI/CD pipelines and repositories","text":"","tags":["protect","AWS"]},{"location":"aws-protect/#require-mfa-for-human-access","title":"Require MFA for human access","text":"<p>Use MFA if you think the identity is important </p>","tags":["protect","AWS"]},{"location":"aws-protect/#migrate-administrators-and-highly-privileged-access-to-just-in-time-access-andor-use-hardware-tokens","title":"Migrate administrators and highly-privileged access to Just in Time access and/or use hardware tokens","text":"","tags":["protect","AWS"]},{"location":"aws-protect/#permission-reduction-and-least-privilege","title":"Permission\u00a0Reduction and Least Privilege","text":"<p>Least Privilege have one role per resources or per app, follow the least privilege principle - [ ] research more on least privilege </p>","tags":["protect","AWS"]},{"location":"aws-protect/#root-account","title":"root-account","text":"<p>Do not use root account. Use IAM user at least, or IAM role. better yet use aws org and accounts.</p> <p>with AWS Organizations, each AWS account in your organization comes with its own root user. These root users have unrestricted administrative access to everything in their AWS accounts. controls for this account before centralized root management is typical e.g. MFA, password rotate, limit permission via SCP Hands-On Security Tips For Centralize Root Access In AWS(AssumeRoot)</p> <p>centralized root access: Hands-On Security Tips For Centralize Root Access In AWS(AssumeRoot) - centralize their management - delete root user credentials - reduced attack surface (with fewer root to manage) - new account won't have root credentials by default - With managed policies, such as\u00a0<code>IAMAuditRootUserCredentials</code>,\u00a0<code>IAMCreateRootUserPassword</code>,\u00a0<code>IAMDeleteRootUserCredentials</code>, <code>S3UnlockBucketPolicy</code>, and <code>SQSUnlockQueuePolicy</code>, you are strictly limited to using only those policies. - If root access is needed, it can be temporarily recovered, used for the specific task, and then removed again.</p> <p>Assuming root would look like this <code>aws sts assume-root --target-principal=123456789 --task-policy-arn arn=arn:aws:iam::aws/root-task/S3UnlockBucketPolicy</code></p> <p>CloudTrail would show <code>AssumeRoot</code> event type see here for example </p>","tags":["protect","AWS"]},{"location":"aws-protect/#related-api-with-centralized-root-management","title":"related API with centralized root management","text":"<p>These are related API with centralized root management that might be of interest when you design detection/ protect Hands-On Security Tips For Centralize Root Access In AWS(AssumeRoot) - check if feature is enabled. <code>ListOrganizationsFeatures</code> - Identify Accounts with Root Access. No simple API, but use these steps:     - assume root with <code>IAMAuditRootUserCredentials</code> <code>aws sts assume-root --target-principal=123456789 --task-policy-arn arn=arn:aws:iam::aws/root-task/IAMAuditRootUserCredentials</code>      - <code>GetLoginProfile</code> API command without providing the <code>UserName</code> <code>aws iam get-login-profile</code>     - If the root account doesn\u2019t have a login profile, you should get the following error:          An error occurred (NoSuchEntity) when calling the GetLoginProfile operation: Login Profile for User null cannot be found.     - Also check for MFA and signed certs -&gt; delete this also</p>","tags":["protect","AWS"]},{"location":"aws-protect/#related-detection-and-response-aws-detect-and-response","title":"related detection and response: aws-detect-and-response","text":"","tags":["protect","AWS"]},{"location":"aws-protect/#credential-report","title":"credential report","text":"<p>https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_getting-report.html</p> <pre><code>aws iam generate-credential-report --profile &lt;aws-cli-profile&gt;\n</code></pre>","tags":["protect","AWS"]},{"location":"aws-protect/#iam-tools","title":"IAM tools","text":"<ul> <li>iamlive </li> <li>Policy Sentry</li> <li>IAM Zero</li> <li>[ ] put this on infosec compendium projects</li> </ul>","tags":["protect","AWS"]},{"location":"aws-protect/#network","title":"network","text":"","tags":["protect","AWS"]},{"location":"aws-protect/#monitor-network-perimeter","title":"Monitor network perimeter","text":"","tags":["protect","AWS"]},{"location":"aws-protect/#know-your-exposed-asset","title":"Know your exposed asset","text":"","tags":["protect","AWS"]},{"location":"aws-protect/#put-guardrails-when-creating-new-vpc","title":"put guardrails when creating new VPC","text":"","tags":["protect","AWS"]},{"location":"aws-protect/#auto-remediation-of-vpc-if-guardrail-is-impossible","title":"auto-remediation of VPC if guardrail is impossible","text":"","tags":["protect","AWS"]},{"location":"aws-protect/#ec2","title":"ec2","text":"","tags":["protect","AWS"]},{"location":"aws-protect/#inventory-of-internet-exposed-ec2","title":"inventory-of-internet-exposed-ec2","text":"<p>have this, because more risky.</p>","tags":["protect","AWS"]},{"location":"aws-protect/#aws-policy","title":"aws-policy","text":"","tags":["protect","AWS"]},{"location":"aws-protect/#policy-primer","title":"policy-primer","text":"<p>these are types or policy - identity based policies (inline and managed) - instances policies - resources based policies - organizational service control policies - organizational resources control policies - permission boundaries - ACL - session policies</p> <ul> <li>[ ] read more on org policies, RCP - SCP</li> </ul> <p>Almost all mid-to-large sized AWS environments make use of\u00a0multi-account architecture. Using multiple AWS accounts offers a number of\u00a0benefits\u00a0and is considered a best practice. To help organize and manage those accounts, AWS offers a service called\u00a0AWS Organizations.</p> <p>Policies in AWS Organizations enable you to apply additional types of management to the AWS accounts in your organization</p>","tags":["protect","AWS"]},{"location":"aws-protect/#policy-basic-principles","title":"policy-basic-principles","text":"<ul> <li>default deny: They are default deny, and can only \"remove deny\". If you see an\u00a0allow\u00a0permission that doesn\u2019t mean something is being granted to someone\u2014 it just means the SCP won\u2019t block it.</li> <li>logical sum </li> <li>deny override allow</li> </ul>","tags":["protect","AWS"]},{"location":"aws-protect/#service-control-policies-scps","title":"Service Control Policies (SCPs)","text":"<p>SCPs DO NOT work on a management account</p> <p>SCP is the OG of Security Invariants- define the maximum permissions of identities in your organization.</p> <p>With service control policies, it is possible to review CloudTrail to determine who may be calling the specific actions that will be denied. </p> <p>SCPs do NOT grant anyone permissions, they only restrict what actions are allowed in an account!\u00a0Service Control Policies are guardrails which restrict what can happen in an account \u2014 they cannot grant permissions to anyone or anything in an account.</p> <p>SCPs do not affect your management account, even when applied to your Organization\u2019s root. This is another good reason to limit use of management accounts. - SCPs can restrict the root (but not management) account.</p> <p>SCP can\u2019t restrict access to resources from entities outside your account (e.g. if you create public s3, the SCP won\u2019t evaluate that API call \u2014 because it happens outside your account). It can however, block creation of public s3, but previously created public s3 will still accessible.</p> <p>SCPs can\u2019t restrict service linked roles (like the one created when we enabled organizations).</p> <p>SCPs are applied at the Organizational Unit or account level.</p> <p>SCP samples: see </p>","tags":["protect","AWS"]},{"location":"aws-protect/#resource-control-policies-rcps","title":"Resource Control Policies (RCPs)","text":"<p>a new type of Organization Policy that defines the maximum permissions of resources in your organization.  Resource Control Policies apply to the resources in your organization and can control any principal, even those outside of your control.\u00a0Only a few services support RCPs\u00a0at this time: S3, KMS, SQS, SecretsManager, and IAM Roles (via STS).  </p> <p>Resource Control Policies are more complicated to preview because you\u2019ll need to enable very expensive CloudTrail DataEvents and review the vast data produced. For some RCPs, you can probably use\u00a0IAM Access Analyser </p> <p>RCP samples: see </p>","tags":["protect","AWS"]},{"location":"aws-protect/#iam-policies","title":"iam-policies","text":"<p>references on aws AWS managed policies exist in every AWS account. Customer managed policies only exist in the account where they are created, so AWS needs to provision those policies into accounts for it all to work.</p>","tags":["protect","AWS"]},{"location":"aws-protect/#declarative-policies","title":"declarative-policies","text":"<p>These policies exist outside of IAM evaluation and enforce specific controls at the AWS Service. You can determine the impactof DP with a simple CSPM review for public images and snapshots. For IMDSv2 enforcement, you can review the CloudWatch Metric\u00a0<code>MetadataNoToken</code>\u00a0to see how many API calls still use the old system.   read more on AWS - [ ] read more on IMDSv2</p>","tags":["protect","AWS"]},{"location":"aws-protect/#permission-boundaries","title":"permission-boundaries","text":"<p>These IAM Policies don\u2019t grant permissions but rather define the maximum permissions of the principal (IAM User or Role) to which they are attached. - [x] read security invariants \u2705 2025-02-02</p>","tags":["protect","AWS"]},{"location":"aws-protect/#examples-of-implementing-policies","title":"examples-of-implementing-policies","text":"<p>note on samples: You should not attach RCPs without thoroughly testing the impact that the policy has on resources in your accounts.  Once you have a policy ready that you would like to implement, we recommend testing in a separate organization or OU that can represent your production environment.  Once tested, you should deploy changes to test OUs and then progressively deploy the changes to a broader set of OUs over time.</p>","tags":["protect","AWS"]},{"location":"aws-protect/#prime-harbor-security-invariants","title":"prime harbor security invariants","text":"<ul> <li>Defining Security Invariants  PrimeHarbor</li> <li>enforce/ alert on things that should always or never be true. idea is if there is no need for context (these things should always or never), no need for sec team time</li> </ul>","tags":["protect","AWS"]},{"location":"aws-protect/#scp-samples","title":"scp-samples","text":"<ul> <li>prime harbor AWS OP github</li> <li>infralicious</li> <li>rami scps</li> <li>aws examples</li> </ul>","tags":["protect","AWS"]},{"location":"aws-protect/#rcp-samples","title":"rcp-samples","text":"<p>samples of RCP</p>","tags":["protect","AWS"]},{"location":"aws-protect/#lesson-learned-from-incidents","title":"lesson-learned-from-incidents","text":"<ul> <li>protect from SSE-C ()<ul> <li>deny object uploads with SSE-C\u00a0encryption </li> <li>Requires KMS\u00a0Encryption (which can be either an AWS\u00a0Managed Key or Customer Managed Key)</li> </ul> </li> </ul>","tags":["protect","AWS"]},{"location":"aws-protect/#note-on-aws-managed-policies","title":"note-on-aws-managed-policies","text":"<p>A SaaS provider's guide to securely integrating with customers' AWS accounts   Datadog Security Labs While policies like <code>ReadOnlyAccess</code> might seem like an easy way to grant limited permissions, AWS managed policies are typically over-privileged and allow overly-sensitive, unnecessary actions. For example:</p> <p>do not use aws managed policy, but use aws managed policy as a starter to build your own.</p> <ul> <li><code>ReadOnlyAccess</code> allows full read access to all data in S3 buckets and DynamoDB tables in the account, as well as read access to all SSM parameters, which typically (and rightly) contain secrets.</li> <li><code>SecurityAudit</code> contains the <code>ec2:DescribeInstanceAttribute</code> permission, which grants privileges to retrieve user data configuration from all EC2 instances, often containing sensitive data or configuration secrets. It also grants <code>lambda:ListFunctions</code>, which permits retrieval of the value of all environment variables for all Lambda functions in the account.</li> </ul> <p>In addition, AWS can add or remove permissions from these policies at any time without notice, and they do so on a daily basis, granting you no control over its lifecycle.</p>","tags":["protect","AWS"]},{"location":"aws-protect/#aws-organizations","title":"aws-organizations","text":"<p>this is the way to scale up your aws deployment. make sure you check this before going organizational: - Never ever ever enable Organizations (or deploy Control Tower) from an account which is running any workloads!!! - have at least one iam account, do not use your root. - use MFA - Protect the management account, minimize who has access, and minimize what you deploy there!!!!  - activate trail (make sure it is multi region) - activate billing alert. use sns if needs be</p>","tags":["protect","AWS"]},{"location":"aws-protect/#magic-roles","title":"magic-roles","text":"<p>these are roles that related to creation of aws organization Service Linked Role: This is a unique type of IAM role directly linked to an AWS service. It\u2019s predefined by the service and includes all the permissions the service needs to perform actions on your behalf. These roles simplify setup since you don\u2019t need to manually add permissions for the service AWSServiceRolesForOrganizations : This role is used by AWS Organizations to enable trusted access for other AWS services. It allows these services to perform tasks across all accounts in your organization, such as managing resources or configurations OrganizationAccountAccessRole : allow root to assume member account</p>","tags":["protect","AWS"]},{"location":"aws-protect/#delegated-administrator","title":"delegated-administrator","text":"<p>Users/roles in a delegated account can administer the service. Each service is a bit different in terms of how much is delegated. For example Identity Center doesn\u2019t let the delegated admin change any permission sets that were created directly in the management account, which helps prevent a delegated admin from making themselves an admin in the management account itself. But nearly all other capabilities are fair game. remember this when you are creating account.</p> <p>this help with least privilege and reducing blast radius</p> <p>if you are delegating IAM identity center, permission AWSSSOMemberAccountAdministrator should also be present in the delegated account</p> <p>for use cases of read more at wiz</p>","tags":["protect","AWS"]},{"location":"aws-protect/#backup-policy","title":"backup-policy","text":"","tags":["protect","AWS"]},{"location":"aws-protect/#aws-backup-encryption","title":"AWS backup encryption","text":"<p>https://docs.aws.amazon.com/aws-backup/latest/devguide/encryption.html</p>","tags":["protect","AWS"]},{"location":"aws-protect/#configuration-management","title":"configuration-management","text":"<p>aws-security-best-practices-cheat-sheet</p>","tags":["protect","AWS"]},{"location":"aws-protect/#scan-with-aws-config","title":"scan with AWS config","text":"<ul> <li>[ ] read more on aws config</li> </ul>","tags":["protect","AWS"]},{"location":"aws-protect/#aws-security-hub","title":"aws-security-hub","text":"<p>Security hub serve three purposes: - Collects events and results from nearly\u00a0any other AWS security service,\u00a0all in one place. and Security Hub normalizes findings from those services into a standard format. (i.e. AWS Security Findings Format - ASFF) - Work as a Cloud Security Posture Management (CSPM) tool. Think of CSPM as a vulnerability scanner for your cloud. - Consolidate events and findings across accounts\u00a0and\u00a0regions in an Organization</p> <p>AWS security hub enable AWS config and security standards. These are expensive, if you are looking to consolidate stuff from other security tool, disable these.</p> <p>read more at security hub - [x] read more on AWS security hubs \u2705 2025-03-06</p>","tags":["protect","AWS"]},{"location":"aws-protect/#aws-risk-management","title":"aws-risk-management","text":"<p>amazon detective - [ ] read on Amazon detective - [ ] read on AWS risk management</p>","tags":["protect","AWS"]},{"location":"aws-protect/#tooling","title":"tooling","text":"","tags":["protect","AWS"]},{"location":"aws-protect/#basic","title":"basic","text":"name description aws-cli the aws-cli, what else aws-shell interactive version of aws-cli","tags":["protect","AWS"]},{"location":"aws-protect/#inventory","title":"inventory","text":"name description aws-inventory tool that tries to discover all\u00a0AWS resources\u00a0created in an account Resource Counter this command line tool counts the number of resources in different categories across Amazon regions. aws_public_ips aws_public_ips is a tool to fetch all public IP addresses (both IPv4/IPv6) associated with an AWS account.","tags":["protect","AWS"]},{"location":"aws-protect/#audit","title":"audit","text":"name description CS-Suite This is a suite of cloud security tools designed to automate various security assessments and tasks CloudSploit CloudSploit is an open-source cloud security scanner. It's designed to detect security risks in cloud infrastructure, including AWS, Azure, Google Cloud, and others. AWS Security Benchmark This project provides scripts and resources to assess AWS environments against security benchmarks, S3Scan S3Scan is specifically designed for scanning Amazon S3 (Simple Storage Service) buckets. CloudMapper Note\u00a0the Network Visualization functionality (command\u00a0<code>prepare</code>) is no longer maintained.CloudMapper helps you analyze your Amazon Web Services (AWS) environments PMapper PMapper focuses on analyzing IAM (Identity and Access Management) policies in AWS. Prowler Prowler is a security assessment, auditing, hardening and forensics tool.","tags":["protect","AWS"]},{"location":"aws-protect/#incident-response","title":"incident response","text":"","tags":["protect","AWS"]},{"location":"aws-protect/#aws-organization","title":"aws-organization","text":"","tags":["protect","AWS"]},{"location":"aws-protect/#organizational-unit","title":"organizational-unit","text":"<p>from slaw At a minimum you want OUs for governance/security, infrastructure/operations, and workloads; as well as places to handle special cases such as incident response, mergers and acquisitions, and accounts you are deprovisioning.</p> <p>Separation of functions. Always keep in mind\u00a0who\u00a0needs to use the account and\u00a0what\u00a0the account needs to do.</p> <p>examples: chris farris ou template terraform and aws reference arch</p>","tags":["protect","AWS"]},{"location":"aws-protect/#accounts","title":"accounts","text":"<p>from slaw When deciding what accounts to create and where, try to use these guidelines:</p> <ul> <li>One of the best security tools in our hierarchy is Service Control Policies (SCPs). For example if you want different ones for development vs. production environments, you should probably have dev and prod OUs.</li> <li>If two things are in different security contexts \u2014 perhaps because one has a lot of compliance requirements, but the other is hosting pictures of your cats \u2014 move them into separate accounts.</li> <li>If application stacks are managed by different teams, put them in different accounts. This makes IAM easier because you can restrict access to the relevant teams.</li> <li>If two applications need to talk to each other and it\u2019s a\u00a0lot\u00a0of data, then\u2026 wait until we get to that lab. This is the hardest decision point because, for cost reasons, you may need to put different workloads managed by different teams into the same account.</li> <li>Separate accounts are also awesome for assigning to different cost centers.\u00a0Much\u00a0easier than trying to use tags.</li> </ul>","tags":["protect","AWS"]},{"location":"aws-protect/#organization-cloudtrail","title":"organization-cloudtrail","text":"<p>why use organization-cloudtrail : - Creates a trail in every account and region in the Org, all using the same configuration. - Centralizes all the logs\u00a0across accounts and regions\u00a0into one S3 bucket. - Handles all the paths and naming for that bucket so you can figure out which account and region a log came from (it uses the account ID and region in the log path). - Within an account you can\u2019t disable or delete the organization trail, which really pisses off attackers.</p>","tags":["protect","AWS"]},{"location":"aws-protect/#best-practice-to-allow-3p-access-to-aws-account","title":"Best practice to allow 3P access to AWS account","text":"<p>Best-practice-to-allow-3P to access AWS accounts</p>","tags":["protect","AWS"]},{"location":"aws-protect/#references-and-related","title":"references-and-related","text":"<ul> <li>hackingthe.clud - AWS orgs</li> <li>cloud-security</li> <li>hackingthe.cloud - IAM identifiers</li> <li>ghost of  cloudsec yet to come</li> <li>marco lancini</li> <li>slaw</li> <li>iam references aws</li> <li>aws-respond</li> </ul>","tags":["protect","AWS"]},{"location":"aws-respond/","title":"about","text":"<p>This page is about respond function in AWS</p>"},{"location":"aws-respond/#ec2-isolation","title":"ec2 isolation","text":"<ul> <li>[ ] \ud83d\udd3c need to recheck this Users can use multiple approaches when isolating an EC2 instance. The approach used will depend on the level of isolation required.</li> </ul> <p>The most common methods of isolation are:</p> <ol> <li>Security Groups</li> <li>NACLs</li> <li>Route Tables</li> <li>Internet Gateways</li> </ol>"},{"location":"aws-respond/#containing-an-ec2-using-security-groups","title":"Containing an EC2 Using Security Groups","text":"<p>Security groups are often the most common approach when isolating an EC2 instance due to their ease of use and targeting isolation capabilities.</p> <p>A security group's default \"implicit deny\" behaviour makes it a suitable isolation method since a security group without rules will deny all traffic; a security group requires a user to specify rules to allow specific traffic.</p> <p>However, it is essential to note that adding a security group to an EC2 instance will not restrict traffic, and AWS will grant access to the security group with the most permissive rules.</p> <p>Therefore to restrict access by using a security group, users must remove all existing security groups from an EC2 instance or remove all the rules from the existing security group.</p> <p>When using security groups for isolation, it is crucial to consider the connections an EC2 instance may establish via a security group. These types of connections are:</p> <ol> <li>Untracked Connections</li> <li>Tracked Connections</li> </ol>"},{"location":"aws-respond/#untracked-connections","title":"Untracked Connections","text":"<p>Untracked connections\u00a0are any connection established from a rule with a \"0.0.0.0/0\" wildcard. The direction of these connections can be both inbound and outbound.</p> <p>The significance of these types of connections is that any change to a security group, such as a rule change or security group change, will immediately affect the traffic flow.</p>"},{"location":"aws-respond/#tracked-connections","title":"Tracked Connections","text":"<p>Tracked connections\u00a0are any connection established from a rule with a specific IP address or segment, such as rules that allow traffic from \"43.101.53.202/32\". The direction of these connections can be both inbound and outbound.</p> <p>Unlike untracked connections, changing a rule within a security group or deleting a security group from an EC2 instance will not immediately affect the traffic flow. This property of tracked connections may allow an attacker to maintain established connections even after the specific rules are removed.</p>"},{"location":"aws-respond/#isolating-ec2-instances-with-tracked-connections","title":"Isolating EC2 instances with Tracked Connections","text":"<p>Users must follow the steps mentioned below to isolate an EC2 instance with a tracked connection:</p> <ol> <li>Create a dedicated isolation security group without any rules</li> <li>Create a single rule of 0.0.0.0/0 for all traffic in both the inbound and outbound rules</li> <li>Remove any existing security groups attached to the EC2 instance</li> <li>Associate the newly created isolation security group to the instance</li> <li>Delete both the inbound and outbound rules you created for the isolation security group</li> </ol> <p>Following these steps will effectively convert all the existing tracked connections into untracked connections, thus terminating any existing connections.</p>"},{"location":"aws-respond/#planning-ahead-with-security-groups","title":"Planning Ahead With Security Groups","text":"<p>Each second could be the difference between successful isolation or further infection in a time-sensitive operation such as an incident response. Therefore users may keep preconfigured security groups that can be used to perform EC2 isolation.</p> <p>a. Create a \u201cStep 01\u201d security group with the following rules</p> <p></p> <p>b. Create a \"Step 02\" security group without any rules</p> <p></p> <p>After creating these two security groups, users will now be able to swiftly isolate an EC2 instance while eliminating any tracked connections by using the following steps:</p> <ol> <li>Remove all existing security groups or rules within existing security groups</li> <li>Add the \u201cStep 1\u201d security group to the EC2 instance</li> <li>Remove the \u201cStep 1\u201d security group from the EC2 instance</li> <li>Associate the \u201cStep 2\u201d security group to the EC2 instance</li> </ol>"},{"location":"aws-respond/#containing-an-ec2-using-nacls","title":"Containing an EC2 Using NACLs","text":"<p>NACLs or Network ACLs is the next approach users may use to isolate an EC2 instance. However, NACLs are not targeted; therefore, it is difficult to isolate an individual EC2 instance using an NACL.</p> <p>A Network ACL relies on rules to allow and deny traffic from subnets; however, unlike security groups, NACLs are stateless, meaning that rules need to be defined for both the request and the response of each connection.</p> <p>The most significant advantage of using a NACL is that there is no multistage process compared to a security group. A single inbound or outbound rule will deny all traffic towards the respective direction.</p> <p>However, since NACLs rely on rules based on subnets. Therefore, using NACLs to isolate an EC2 instance will affect all the other instances within the specified subnet.</p> <p>Users may choose to use an existing NACL for isolation. In this method, users are required to add the deny rule as the first rule of the NACL; if the NACL is full existing rules may need to be removed to make space for the isolation-specific rules at the top of the NACL.</p> <p>The other approach is to create a new NACL with the deny rules at the start of the NACL and to associate the dedicated isolation NACL to the VPC that hosts the affected EC2 instance.</p>"},{"location":"aws-respond/#containing-an-ec2-using-route-tables","title":"Containing an EC2 Using Route Tables","text":"<p>Users can use route tables to isolate EC2 instances to move up the isolation spectrum. Route tables are an excellent method of isolating EC2 instances from all external networks, such as Internet Gateways, Direct Connections and VPN connections.</p> <p>However, it is essential to understand that the route table is associated with the VPC that hosts the EC2 instance and not the EC2 instance itself. Therefore even though using a route table for isolation terminates all connections to all external networks, it will also disrupt any connection flowing through the specific VPC.</p> <p>Additionally, isolating EC2 instances using route tables will restrict external access to the affected EC2 instance. However, it will still be able to communicate within the subnet and continue to spread to other resources within the same subnet.</p>"},{"location":"aws-respond/#containing-ec2-using-internet-gateways","title":"Containing EC2 Using Internet Gateways","text":"<p>EC2 Isolation using internet gateways restricts internet connectivity to the VPCs that host the EC2 instances. However, restricting access using internet gateways are not straightforward since AWS will not allow users to remove the internet gateways if any EC2 dependencies within the VPC require the internet gateway.</p> <p>Users are required to remove all dependencies to isolate an EC2 instance using an internet gateway successfully. However, this is not feasible during an incident response scenario.</p> <p>Instead, users may obtain the same effect by removing all the internet gateway routes from the routing table or attaching a custom route table with no rules for all subnets.</p>"},{"location":"aws-respond/#ec2-containment-playbook","title":"EC2 Containment Playbook","text":"<p>A well-balanced and practical incident response playbook must cover all possible aspects when containing an affected resource. It must not restrict itself to a network containment approach but explore all possible methods of limiting access to and from the affected EC2 instance.</p> <p>The following playbook provides a good starting point for organizations to adopt an EC2 containment playbook that covers most basic containment areas.</p> <ol> <li>Tag and detach the EC2 instance from any auto-scaling group</li> <li>Create a new security group that denies both inbound and outbound traffic (Empty Security Group)</li> <li>Remove any existing security groups and associate them with the \u201cempty\u201d security group</li> <li>Remove any IAM roles associated with the instance</li> <li>Create a snapshot of the root volume</li> <li>Create an AMI (Amazon Machine Image) of the instance for later analysis</li> </ol> <p>It is also important to tag all entities used for isolation so that the same resources will not be used for any other business operation that can render the isolation ineffective.</p>"},{"location":"aws-respond/#ec2-contain-with-automation","title":"EC2 contain with automation","text":"<p>or automate with lambda here</p> <p>or check the automation here</p>"},{"location":"aws-respond/#aws-iam","title":"aws iam","text":"<p>https://aws.amazon.com/blogs/security/what-to-do-if-you-inadvertently-expose-an-aws-access-key/</p>"},{"location":"aws-respond/#reference-and-related","title":"reference-and-related","text":"<p>infosec-compendiums aws-protect dev.to/aws-builders</p>"},{"location":"aws-security-tips/","title":"AWS Security Tips","text":"<p>The categorization of domains are based off CSMM to make it easier to tackle</p>"},{"location":"aws-security-tips/#foundational-domain","title":"Foundational Domain","text":"<p>Foundationals are: Core, critical categories to ensure availability of a secure baseline.</p>"},{"location":"aws-security-tips/#governance","title":"Governance","text":""},{"location":"aws-security-tips/#organization","title":"Organization","text":""},{"location":"aws-security-tips/#root-user","title":"root user","text":""},{"location":"aws-security-tips/#create-admin","title":"create-admin","text":"<p>use MFA!</p>"},{"location":"aws-security-tips/#limit-root-account","title":"limit root account","text":"<p>also see #protect-ou</p>"},{"location":"aws-security-tips/#delegated-administrator","title":"delegated administrator","text":"<p>delegate management account privilege with this. use for IAM, billing, so you don't have to check billing using high privilege account day to day basis</p> <p>read more about delegated administrator at aws protect more here: slaw and aws</p>"},{"location":"aws-security-tips/#create-aws-organization","title":"create aws organization","text":""},{"location":"aws-security-tips/#set-up-org-contact","title":"set up org contact","text":"<p>security contact is important to set up, aside from that  create:  - Billing information - Operational information - Security information also see security account at aws detect &amp; response</p> <p>how to?  - enable trusted access for aws account management - change email account at the contact info of the management account</p>"},{"location":"aws-security-tips/#create-ou","title":"create ou","text":"<p>At a minimum you want OUs for governance/security, infrastructure/operations, and workloads; as well as places to handle special cases such as incident response, mergers and acquisitions, and accounts you are deprovisioning.</p> <p>one example, you need these accounts : security, infra, workload, IR, nursery, onboarding, sandbox, suspended, exceptions. also see security account at aws detect &amp; response</p> type name function OU Security OU Workload/Prod OU Infrastructure OU Exception OU Suspended OU Oboarding #### protect ou <p>these OU should have policy to deny these things, except the exception OU! 1. leave org. 2. deny root any action -&gt; or kill root account or use root central management <pre><code>{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Action\": [\n        \"organizations:LeaveOrganization\"\n      ],\n      \"Resource\": \"*\",\n      \"Effect\": \"Deny\"\n    },\n    {\n      \"Action\": \"*\",\n      \"Resource\": \"*\",\n      \"Effect\": \"Deny\",\n      \"Condition\": {\n        \"StringLike\": {\n          \"aws:PrincipalArn\": [\n            \"arn:aws:iam::*:root\"\n          ]\n        }\n      }\n    }\n  ]\n}\n</code></pre></p>"},{"location":"aws-security-tips/#policies","title":"policies","text":""},{"location":"aws-security-tips/#invariants","title":"invariants","text":"<p>invariants are: enforce/ alert on things that should always or never be true. idea is if there is no need for context (these things should always or never), no need for sec team time</p> <p>Here are some examples of invariants you can apply in your policies: - Configure account-wide security defaults, including S3 block public access, EBS and all other default encryption.</p>"},{"location":"aws-security-tips/#deny-unused-region","title":"deny unused region","text":"<p>if your org do not use a certain region, just block that. reduce attack surface.</p> <p>when you are writing the policy, remember this: Deny statements override allow statements, but allow statements in different policies all add up together.</p> <p>We use double negatives in AWS policies because they enable us to say \u201cblock everything except this\u201d. This keeps us secure when new services, permissions (e.g., IAM user policies), actions, or regions are added!</p> <p>also see other scp examples on </p> <pre><code>{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Sid\": \"DenyAllOutsideRegions\",\n      \"Effect\": \"Deny\",\n      \"NotAction\": [\n        \"a4b:*\",\n        \"acm:*\",\n        \"aws-marketplace-management:*\",\n        \"aws-marketplace:*\",\n        \"aws-portal:*\",\n        \"budgets:*\",\n        \"ce:*\",\n        \"chime:*\",\n        \"cloudfront:*\",\n        \"config:*\",\n        \"cur:*\",\n        \"directconnect:*\",\n        \"ec2:DescribeRegions\",\n        \"ec2:DescribeTransitGateways\",\n        \"ec2:DescribeVpnGateways\",\n        \"fms:*\",\n        \"globalaccelerator:*\",\n        \"health:*\",\n        \"iam:*\",\n        \"importexport:*\",\n        \"kms:*\",\n        \"mobileanalytics:*\",\n        \"networkmanager:*\",\n        \"organizations:*\",\n        \"pricing:*\",\n        \"route53:*\",\n        \"route53domains:*\",\n        \"route53-recovery-cluster:*\",\n        \"route53-recovery-control-config:*\",\n        \"route53-recovery-readiness:*\",\n        \"s3:GetAccountPublic*\",\n        \"s3:ListAllMyBuckets\",\n        \"s3:ListMultiRegionAccessPoints\",\n        \"s3:PutAccountPublic*\",\n        \"shield:*\",\n        \"sts:*\",\n        \"support:*\",\n        \"trustedadvisor:*\",\n        \"waf-regional:*\",\n        \"waf:*\",\n        \"wafv2:*\",\n        \"wellarchitected:*\"\n      ],\n      \"Resource\": \"*\",\n      \"Condition\": {\n        \"StringNotEquals\": {\n          \"aws:RequestedRegion\": [\n            \"us-east-1\",\n            \"us-west-2\"\n          ]\n        }\n      }\n    }\n  ]\n}\n</code></pre> <p>details here</p>"},{"location":"aws-security-tips/#identity","title":"Identity","text":"<p>Identity perimeters from cloud security:</p> <ol> <li>management plane access model: you should have information how management plane access happens, and understand risk of them. in the future aim for single, auditable mechanism e.g. AWS SSO with your IdP (with phish resistant tech.)    Remove insecure mechanism such as Access Key/Secret Key, any use of IAM Users directly, unused users and roles, and ensure secure configurations are used for cross-account access for humans (MFA) and services (ExternalID).</li> <li>server access model: understand what are currently use and the risk, mitigate/remediate and try to aim for best practice in the long run. SSH w/ key (no password!) &gt; bastion/ jump host &gt; AWS SSM.    in short term, get compensating control fail2ban, bastion but aim for the ideal cloud native offering(SSM)</li> <li>IAM Security: do not use/secure root; clean up unused roles -&gt; see access analyzer result; use IAM roles instead of users; understand risk of cross-account trust;<ul> <li>IAM Credential Report: Identify unused users and roles, and well as authentication patterns, such as MFA usage.</li> <li>IAM Access Analyzer: Identify resources in your accounts shared with external entities.</li> <li>Trusted Advisor\u00a0(free): Multi-factor authentication on root account, AWS IAM use.</li> <li>AWS Config\u00a0and/or\u00a0Security Hub, if in use.</li> </ul> </li> </ol>"},{"location":"aws-security-tips/#account","title":"account","text":"<ul> <li>as a guidance have at minimum these account, also read about #delegated-administration</li> <li>Ensure security visibility and break-glass access to all accounts.</li> </ul> OU name desc. info Security SecurityAudit delegated administrator for cloudtrail function SecurityAudit and LogArchive is separated. so ops can access log without messing with cloudtrail Security LogArchive create, access, maintain storing of cloudtrail in s3. SecurityAudit and LogArchive is separated. so ops can access log without messing with cloudtrail Security IAM delegated administrator for IAM function Security SecOps"},{"location":"aws-security-tips/#roles","title":"roles","text":""},{"location":"aws-security-tips/#security-permission","title":"security permission","text":"<ul> <li>Ensure security visibility and break-glass access to all accounts.</li> </ul> <p>set up permission role for security with this pattern: - A\u00a0full-read role\u00a0with a read-only policy. - A\u00a0full admin\u00a0role that can do anything (for break glass, incident response) - An\u00a0IAM role - additional cross-account role</p> <p>set up by following the steps: create permission set -&gt; create group (if needed) -&gt;  assign account the group and permission set.</p> <p>more here at slaw and aws</p>"},{"location":"aws-security-tips/#security-monitoring","title":"Security Monitoring","text":""},{"location":"aws-security-tips/#setup-organization-cloudtrail","title":"setup organization cloudtrail","text":"<ul> <li>Enable Cloudtrail in all accounts; turn on optional security features, including encryption at-rest and file validation; centralize and back up logs.</li> <li>setup organization cloud trail, make sure it is multi trail. use LogArchive user to set it up. the s3 where it store should have lifecycle and versioning (send to glacier if needed).</li> <li>use your log archive account -&gt; go to s3 -&gt; go to org cloudtrail -&gt; management -&gt; lifecycle rule -&gt; choose apply to all object -&gt; tick expire current version of object -&gt; put in how many days at the bottom</li> </ul>"},{"location":"aws-security-tips/#guardduty","title":"guardduty","text":"<ul> <li>enable GuardDuty and delegate admin to your SecurityAudit account. </li> <li>enable GuardDuty in all accounts, and centralize alerts.</li> <li>also remember to turn on auto enable for all account, check in account tab in guardduty see if all account is enabled.</li> <li>also remember to enable in all your region.</li> </ul>"},{"location":"aws-security-tips/#aws-security-hub","title":"aws security hub","text":"<p>enable securityhub, but if you are looking just to aggregate findings (without config and standards), do not use aws config and standard, because this can get costly. more on </p> <p>you can later connect security hub to siem using cloudwatch or load from s3 bucket. more at aws and also aws in using securityhub and opensearch</p>"},{"location":"aws-security-tips/#structural-domain","title":"Structural Domain","text":"<p>Structural Domains are Categories to protect the building blocks of your cloud environment.</p>"},{"location":"aws-security-tips/#network","title":"network","text":"<p>enumerate and understand the risk of your network perimeter (from cloudsec):</p> <ol> <li>Public resources in managed services: understand resources that allow to be public thorugh RCP, sharing API, network access. read more</li> <li>Public network access to hosted services: leverage findings from tooling or trusted advisor, security groups that are open etc.</li> <li>Default, insecure resources</li> </ol>"},{"location":"aws-security-tips/#workload","title":"workload","text":""},{"location":"aws-security-tips/#application","title":"application","text":""},{"location":"aws-security-tips/#data","title":"data","text":""},{"location":"aws-security-tips/#procedural-domain","title":"Procedural Domain","text":"<p>Procedural Domains are Categories to highlight the processes needed to protect your cloud (and keep it protected)</p>"},{"location":"aws-security-tips/#risk-assessment","title":"Risk assessment","text":""},{"location":"aws-security-tips/#resilience","title":"Resilience","text":""},{"location":"aws-security-tips/#compliance-and-audit","title":"Compliance and Audit","text":""},{"location":"aws-security-tips/#incident-response","title":"Incident Response","text":""},{"location":"aws-security-tips/#references","title":"References","text":"<p>slaw aws protect aws detect and response org-kickstart CSMM cloudsec orienteering</p>"},{"location":"best-practice-to-allow-3p-to-access-aws-accounts/","title":"Allow 3P/SaaS to access AWS accounts","text":"<p>[[A SaaS provider's guide to securely integrating with customers' AWS accounts   Datadog Security Labs]]</p> <p>AWS guide</p>","tags":["AWS","cloudsec","protect"]},{"location":"best-practice-to-allow-3p-to-access-aws-accounts/#summary","title":"Summary","text":"<p>The article list Best practice for SaaS when integrating with customer's AWS account</p> <p>Protect the customer's environment: How can you make sure that you're accessing your customers' AWS accounts in a secure way, with proper tenant isolation? - Minimize customer impact in case you are (as a provider) compromised: How can you minimize customer impact in case one of your own applications or cloud environments is compromised? - Secure your own cloud environment: What are some best practices to follow to secure the cloud environment that integrates with customers' AWS accounts?</p>","tags":["AWS","cloudsec","protect"]},{"location":"best-practice-to-allow-3p-to-access-aws-accounts/#use-iam-role-instead-iam-user","title":"Use IAM role instead IAM user","text":"<p>Don't ask your customers to create IAM users. Instead, have them create an IAM role, and set its trust policy to allow cross-account access from your own AWS account. IAM users have long-lived credentials that never expire</p> <p>Leveraging IAM roles for your integration ensures that:</p> <ul> <li>You're not weakening the security posture of your customers by asking them to follow bad IAM practices;</li> <li>You don't have to store cloud credentials, which would be a large liability in itself;</li> <li>If your backend application leaks customer cloud credentials, they are only valid for a maximum of 12 hours.</li> </ul>","tags":["AWS","cloudsec","protect"]},{"location":"best-practice-to-allow-3p-to-access-aws-accounts/#generate-a-random-externalid-and-have-your-customers-enforce-it-in-their-roles-trust-policy","title":"Generate a random ExternalId and have your customers enforce it in their role's trust policy","text":"<p>When used in the context of a multi-tenant SaaS application, IAM roles can be vulnerable to the \"confused deputy\" attack.</p> <p>To prevent confused deputy attacks, your service needs to generate an \"external ID\" that's unique to each customer. Customers must then configure their IAM role to ensure that the proper external ID is passed when your service performs the <code>sts:AssumeRole</code> call. </p> <p>example [[A SaaS provider's guide to securely integrating with customers' AWS accounts   Datadog Security Labs#Generate a random ExternalId and have your customers enforce it in their role's trust policy | here]]</p>","tags":["AWS","cloudsec","protect"]},{"location":"best-practice-to-allow-3p-to-access-aws-accounts/#minimize-and-document-permissions-that-your-integration-requires","title":"Minimize and document permissions that your integration requires","text":"<p>Provide customers with the exact IAM policy they need to attach to their integration role. Projects such as iamlive, Policy Sentry, and IAM Zero can help you better understand what specific permissions your application needs.</p>","tags":["AWS","cloudsec","protect"]},{"location":"best-practice-to-allow-3p-to-access-aws-accounts/#avoid-the-use-of-aws-managed-policies","title":"Avoid the use of AWS managed policies","text":"<p>While policies like <code>ReadOnlyAccess</code> might seem like an easy way to grant limited permissions, AWS managed policies are typically over-privileged and allow overly-sensitive, unnecessary actions. </p> <p>In addition, AWS can add or remove permissions from these policies at any time without notice, and they do so on a daily basis, granting you no control over its lifecycle.</p>","tags":["AWS","cloudsec","protect"]},{"location":"best-practice-to-allow-3p-to-access-aws-accounts/#implement-paved-roads-and-guardrails-for-your-customers","title":"Implement paved roads and guardrails for your customers","text":"","tags":["AWS","cloudsec","protect"]},{"location":"best-practice-to-allow-3p-to-access-aws-accounts/#provide-configurable-infrastructure-as-code-modules-for-setting-up-integrations","title":"Provide configurable infrastructure as code modules for setting up integrations","text":"","tags":["AWS","cloudsec","protect"]},{"location":"best-practice-to-allow-3p-to-access-aws-accounts/#request-an-easy-one-click-way-to-set-up-your-integration","title":"request an easy, one-click way to set up your integration.","text":"<p>This is typically done through a CloudFormation template hosted on a public S3 bucket</p> <p>examples [[A SaaS provider's guide to securely integrating with customers' AWS accounts   Datadog Security Labs#Implement paved roads and guardrails for your customers | here]]</p>","tags":["AWS","cloudsec","protect"]},{"location":"best-practice-to-allow-3p-to-access-aws-accounts/#use-automation-by-requesting-a-terraform-provider-with-a-resource-to-configure-your-aws-integration","title":"Use automation by requesting a Terraform provider with a resource to configure your AWS integration.","text":"<p>examples [[A SaaS provider's guide to securely integrating with customers' AWS accounts   Datadog Security Labs#Implement paved roads and guardrails for your customers | here]]</p>","tags":["AWS","cloudsec","protect"]},{"location":"best-practice-to-allow-3p-to-access-aws-accounts/#check-integration-role-when-external-ids-are-not-enforced","title":"check integration role when external IDs are not enforced","text":"<p>examples [[A SaaS provider's guide to securely integrating with customers' AWS accounts   Datadog Security Labs#Implement paved roads and guardrails for your customers | here]] and AWS guide</p>","tags":["AWS","cloudsec","protect"]},{"location":"best-practice-to-allow-3p-to-access-aws-accounts/#check-if-the-integration-role-when-its-dangerously-over-permissive","title":"check if the integration role when it's dangerously over-permissive","text":"<p>examples [[A SaaS provider's guide to securely integrating with customers' AWS accounts   Datadog Security Labs#Implement paved roads and guardrails for your customers | here]]</p>","tags":["AWS","cloudsec","protect"]},{"location":"best-practice-to-allow-3p-to-access-aws-accounts/#make-integration-more-resilient-to-3p-potential-compromise","title":"Make  integration more resilient to 3P potential compromise","text":"<p>list of things to increase resilience when 3P compromise happens</p>","tags":["AWS","cloudsec","protect"]},{"location":"best-practice-to-allow-3p-to-access-aws-accounts/#make-sure-vendor-is-monitoring-usage-of-outbound-integration-role-through-cloudtrail-assumerole-events","title":"Make sure vendor is monitoring usage of outbound integration role through CloudTrail <code>AssumeRole</code> events","text":"<p>some anomalies to be aware for: (vendor should be monitoring this) - The role is assumed by a human operator: This could indicate an operator attempting to compromise customer credentials. - The role is assumed by a non-AWS IP address: This could indicate that someone outside of your infrastructure has attempted to compromise the role. - A specific session of the role is used in different locations: This could indicate that your backend application was compromised, and that an 1attacker has exfiltrated its credentials outside of your environment. - An unusual number of <code>AssumeRole</code> calls are performed: If you have 100 customer environments you're scanning once a day, you should be concerned if your outbound integration role starts mass-assuming customer roles within a short time window. - Unusual role session names: If your backend application assumes integration roles with a specific session name, you want to know when something looks off.</p> <ul> <li>[ ] check if this should be on AWS protect compendium</li> </ul>","tags":["AWS","cloudsec","protect"]},{"location":"best-practice-to-allow-3p-to-access-aws-accounts/#consider-using-a-dedicated-bastion-aws-account","title":"consider using a dedicated bastion AWS account","text":"<p>[[A SaaS provider's guide to securely integrating with customers' AWS accounts   Datadog Security Labs]]</p>","tags":["AWS","cloudsec","protect"]},{"location":"best-practice-to-allow-3p-to-access-aws-accounts/#make-judicious-use-of-sts-session-policies","title":"Make judicious use of STS Session Policies","text":"<p>When assuming an IAM role, you can choose to restrict the effective permissions of the returned credentials by using Session Policies. This can be useful when you know that the operations you're about to perform don't require as many privileges as the ones granted to the role.</p> <ul> <li>[ ] read more on STS session policies</li> </ul> <p>When Saas uses microservices for different thing (cost monitoring, scanning posture): In that case, session policies are valuable to make sure that each microservice has access to minimally scoped credentials, independently of the privileges that are granted to the assumed IAM role.</p>","tags":["AWS","cloudsec","protect"]},{"location":"best-practice-to-allow-3p-to-access-aws-accounts/#maintain-dynamic-list-of-3p-used-ip-ranges","title":"Maintain dynamic list of 3P used IP ranges","text":"<p>if allow-list of fixed IP is impossible, strive to maintain dynamic IP used by 3P( example https://docs.datadoghq.com/api/latest/ip-ranges/)</p> <p>for example monitor if <code>AssumeRole</code> come from unlisted IP list.</p>","tags":["AWS","cloudsec","protect"]},{"location":"best-practice-to-allow-3p-to-access-aws-accounts/#use-regional-outbound-integration-roles","title":"Use regional outbound integration roles","text":"<p>if you operate in several region, consider using a dedicated outbound integration role per region, and instruct customers in each region to trust the appropriate role. Limit exposure to that region when things go bad.</p>","tags":["AWS","cloudsec","protect"]},{"location":"best-practice-to-allow-3p-to-access-aws-accounts/#require-3p-to-provide-a-single-iam-role-to-trust-instead-of-a-whole-account","title":"Require 3P to provide  a single IAM role to trust, instead of a whole account","text":"","tags":["AWS","cloudsec","protect"]},{"location":"cloud-security/","title":"Cloud Security","text":"","tags":["cloudsec","MOC"]},{"location":"cloud-security/#cloud-security-program","title":"cloud security program","text":"<p>This section talks about building, maintaining, upgrading your cloudsec program.</p>","tags":["cloudsec","MOC"]},{"location":"cloud-security/#cloudsec-orienteering","title":"cloudsec orienteering","text":"<p>based off rami mac cloud security orienteering</p> <p>this is not a full cloud security program but more on how to orientate in a cloud environment, dig in to identify the risks that matter, and put together actionable plans that address short, medium, and long term goals.</p>","tags":["cloudsec","MOC"]},{"location":"cloud-security/#core-principles","title":"core principles","text":"<p>these are principles you use when doing orienteering, keep these in mind.</p> <ul> <li>breadth, then depth: do not go too deep, instead go wide and understand all the context;</li> <li>anomaly detection: you are basically trying to find anomaly, things out of ordinary, out of norm;</li> <li>inside out and outside in: do it from the inside -&gt; maximum read access, but also try to do it/ emulate attackers perspective;</li> </ul>","tags":["cloudsec","MOC"]},{"location":"cloud-security/#corporate-archaeology","title":"corporate archaeology","text":"<p>the goal is to understand your estate:</p> <ol> <li>Architecture diagrams or documentation of intended workloads.</li> <li>Definition of \"crown jewels\", the unique set of data that is identified by the business as the most sensitive if compromised. </li> <li>Intended authentication and identity approach.</li> </ol> <p>these are ideas on how you would find information asset:</p> <ul> <li>Identify and review any existing asset inventory</li> <li>review IaC (terraform, ansible, puppet, cloudformation)</li> <li>Review any data classification and designation of scope for those classes of data</li> <li>Review organizational documentation: Wikis, Documents</li> <li>Identify any existing cloud security tools or vendors in use</li> </ul> <p>the steps are to find environments (accounts/ orgs) -&gt; workloads (e.g. project x; ecommerce x) -&gt; services (EC2, S3) -&gt; resources (individual resources)</p> <ul> <li>[ ] expand on this</li> </ul> <p>ideas on findings environments (accounts) from summitroute</p>","tags":["cloudsec","MOC"]},{"location":"cloud-security/#prioritization","title":"prioritization","text":"<p>The next step to distill all the information you\u2019ve gathered in actionable guidance, focused on what is\u00a0most immediately important.</p>","tags":["cloudsec","MOC"]},{"location":"cloud-security/#identity-perimeter","title":"identity perimeter","text":"<ol> <li>management plane access model: you should have information how management plane access happens, and understand risk of them. in the future aim for single, auditable mechanism e.g. AWS SSO with your IdP (with phish resistant tech.)    Remove insecure mechanism such as Access Key/Secret Key, any use of IAM Users directly, unused users and roles, and ensure secure configurations are used for cross-account access for humans (MFA) and services (ExternalID).</li> <li>server access model: understand what are currently use and the risk, mitigate/remediate and try to aim for best practice in the long run. SSH w/ key (no password!) &gt; bastion/ jump host &gt; AWS SSM.    in short term, get compensating control fail2ban, bastion but aim for the ideal cloud native offering(SSM)</li> <li>IAM Security: do not use/secure root; clean up unused roles -&gt; see access analyzer result; use IAM roles instead of users; understand risk of cross-account trust;<ul> <li>IAM Credential Report: Identify unused users and roles, and well as authentication patterns, such as MFA usage.</li> <li>IAM Access Analyzer: Identify resources in your accounts shared with external entities.</li> <li>Trusted Advisor\u00a0(free): Multi-factor authentication on root account, AWS IAM use.</li> <li>AWS Config\u00a0and/or\u00a0Security Hub, if in use.</li> </ul> </li> </ol>","tags":["cloudsec","MOC"]},{"location":"cloud-security/#network-perimeter","title":"network perimeter","text":"<ol> <li>Public resources in managed services: understand resources that allow to be public thorugh RCP, sharing API, network access. read more</li> <li>Public network access to hosted services: leverage findings from tooling or trusted advisor, security groups that are open etc.</li> <li>Default, insecure resources</li> </ol>","tags":["cloudsec","MOC"]},{"location":"cloud-security/#hosted-application","title":"hosted application","text":"<ul> <li>Out of date services, especially ones with known vulnerabilities.  </li> <li>Unauthenticated services that are unintentionally exposed.</li> <li>Sensitive or internal services that are needlessly public, such as CI/CD tools.</li> </ul> <p>understand the risk vs ticking box, example: here</p>","tags":["cloudsec","MOC"]},{"location":"cloud-security/#future-planning","title":"future planning","text":"<p>To start, consider a blanket set of (fairly) universally applicable AWS hardening recommendations, including</p> <ul> <li>Enable GuardDuty in all accounts, and centralize alerts.</li> <li>Enable Cloudtrail in all accounts; turn on optional security features, including encryption at-rest and file validation; centralize and back up logs. </li> <li>Ensure security visibility and break-glass access to all accounts.</li> <li>Configure account-wide security defaults, including S3 block public access, EBS and all other default encryption.</li> </ul> <p>use maturity framework to have a map CSMM marco lancini cloudsec map</p>","tags":["cloudsec","MOC"]},{"location":"cloud-security/#10x-cloudsec","title":"10x-cloudsec","text":"<p>How to 10X Your Cloud Security (Without the Series D) ~ Rami McCarthy</p>","tags":["cloudsec","MOC"]},{"location":"cloud-security/#30-60-90-180d-chris-farris","title":"30-60-90-180d chris farris","text":"<p>this is from ghost of cloudsec yet to come</p> <p>The 30-day plan is about ensuring the basics are in place. </p> <ol> <li>Is CloudTrail enabled and feeding the SEIM?</li> <li>Are there dedicated security &amp; logging accounts?</li> <li>Does the security account have audit capability to the environment?</li> <li>Do you have GuardDuty enabled?</li> <li>Do you know all of the accounts you have and who is accountable for them? What is the multi-account strategy?</li> <li>Are cloud users leveraging federated identities or IAM Users?</li> <li>Is there a security baseline for cloud usage? What security policies, standards, and baselines do exist?</li> <li>Who are the core cloud constituencies? How do they see the current security team? Who will be allies, and who do you need to influence?</li> </ol> <p>The 60-day plan would focus on situational awareness and introducing the cloud security program to the company\u2019s broader cloud user community.</p> <ol> <li>Deploy a CSPM solution. Probably something free.</li> <li>Deploy IAM Access Analyzer</li> <li>Review the CSPM and access analyzer results for the most egregious issues and target them as part of the initial outreach. By egregious issues, I\u2019m referring to 3389 open to the world on a windows box or unauthenticated elastic search clusters. Encryption, public buckets, etc., are not on this list.</li> <li>Deploy an auto-remediation tool like Cloud Custodian, but do it in notify-only mode. Hold the findings internally for a risk-based targeted outreach.</li> <li>If you\u2019re ambitious, price out and consider using Macie to scan the public buckets for PII.</li> <li>Start creating your KRIs.\u00a0Don\u2019t share them with anyone just yet.\u00a0Understand how your KRI automation reflects the risk to the business and adjust accordingly.</li> <li>Leverage the CSPM and auto-remediation tools findings to advise how to proceed. For the last point - which teams or accounts have the most findings? Is there a pattern of opening security groups because there is no architectural pattern for secure on-prem or on-network connectivity? If so, fix that.</li> </ol> <p>Begin the user education phase of things -&gt; democratizing security. also see rami</p> <ol> <li>Write a security baseline or security best practices document for the development community. Be careful here. If this document becomes part of the formal GRC/Policy framework, you\u2019ve fallen into the Tar-Pit of CSPM, and you\u2019ve become part of the compliance police. The goal is a secure environment, so focus on developer education.</li> <li>Introduce a core set of SCPs to cover the security invariants that the security and cloud user community can agree on. Develop a mutual understanding of how exceptions might be handled.</li> <li>Work with teams to get the CloudCustodian notifications delivered to the teams themselves, rather than just the security team. Still, in notify-only mode, they now start to see in real-time the new issues being created. This avoids swamping them with eight years of un-encrypted snapshots and databases and demoralizing them with thousands of findings.</li> <li>Start building out the IaC scanning according to your company\u2019s risk profile.</li> </ol> <p>Now you\u2019re ready to enable the full suite of preventative controls 1. Ensure the developers are using IaC scanning. They know what is coming via the auto-remediation and Service Control Policies. They know their deployments will fail if certain things are not resolved. 2. Enable the next level of SCPs to prevent things at the IAM phase. This will cause pipelines to break and throw weird errors at users doing ClickOps. 3. Enable the auto-remediation capability in Cloud Custodian (first in dev accounts, then in prod). IaC scanning should prevent these policies from firing in automated accounts, so this is a way to catch errors via ClickOps or pipeline operators who ignore the warnings. Remember: actual remediation must be against high security-risk misconfigurations, where the remediation is low operational risk. 4. Start monitoring your KRIs. Do you see a drop-off in the older CSPM findings? If yes, great, keep things moving along. 5. If your KRIs indicate a certain class of risk is not going down, consider a targeted effort to resolve those. 6. If you deploy a CSPM vulnerability management program with SLAs, ensure that high-effort-to-remediate findings aren\u2019t just added to a spreadsheet. They must be part of a risk-informed architectural review.</p>","tags":["cloudsec","MOC"]},{"location":"cloud-security/#rami-mac","title":"rami-mac","text":"<p>this is from his podcast talk on O3 cyber podcast</p> <pre><code>mindmap\n    root(program)\n        visibility\n            horizontal: asset, csp, stack?\n            vertical: prioritize on key risk, not too deep\n        posture\n            asses critical risk\n        defense\n            monitoring, IR plan, log scaling\n        democratizing security\n            guardrail vs gatekeep\n            empower developer </code></pre> <ul> <li>Visibility First: Ramy emphasizes the importance of visibility in security, focusing on both organizational and technical aspects.  <ul> <li>He suggests a 30-60-90 day plan for new roles, prioritizing understanding relationships and business context. The visibility should be horizontal and vertical (altitude)</li> <li>horizontal example: what asset? what CSP we use? what tech stack?</li> <li>vertical example: since this is a strategy, we still need a bit of a height, so the vertical should not be too deep on everything, but prioritize on key risk.</li> <li>A way of prioritizing is using Three Perimeters Model: rami introduces a model focusing on identity, network, and application perimeters in the cloud. <ul> <li>Identity Perimeter: Cloud management plane, infrastructure access, and third-party identities. </li> <li>Network Perimeter: Public resources and managed services (s3 buckets), public network access and hosted services (i.e. public IP) and exposure management. </li> <li>Application Perimeter: Vulnerability management and insecure platforms. </li> </ul> </li> </ul> </li> <li>Visibility, Posture, and Defense: Follow a cycle that starts with visibility, moves to assessing critical risks (posture), and then focuses on monitoring, detection, and response (defense). </li> <li>Business Context: Understand the business context and strategy to make security relevant and gain support. </li> <li>Strategy Post 90 Days: Ramy suggests that a cloud security strategy should provide a consistent model to discuss progress. He recommends using maturity models or frameworks, like the Cyber Defense Matrix, to benchmark and track progress. </li> <li>The Next Big Thing: Ramy believes the focus should be on making the basics easier and more achievable, particularly in identity security. He highlights AI's role in driving awareness of existing gaps, especially in data security. </li> <li>Democratized Security: Ramy advocates for empowering local experts with shared context, emphasizing the shift towards developers owning their code and the need for security tools to facilitate collaboration. </li> </ul>","tags":["cloudsec","MOC"]},{"location":"cloud-security/#30-60-90d","title":"30-60-90d","text":"<p>30d: assess \u2022Assess \u2022Build relationships \u2022Establish baseline 60d: better \u2022Do one thing better \u2022Nail it \u2022Add invariants for your baseline 90d: scale and ROI \u2022Plan for scale \u2022Reproducible process \u2022Security ROI \u2022Kill a class of risk</p> <p>scaling -&gt; democratizing security</p>","tags":["cloudsec","MOC"]},{"location":"cloud-security/#philosophy","title":"philosophy","text":"<p>Do things that don\u2019t scale, automate as much as possible to scale High-signal, low-noise tools and alerting       - okay not to catch everything, but when it catch something, it is impactful Guardrails, not gatekeepers  Security as partnership. Embed security in development process      - try to eventually scale this: automate, guardrail, baseline Tools devs can build, others can operate  The limits of desirable security</p>","tags":["cloudsec","MOC"]},{"location":"cloud-security/#security-program","title":"security-program","text":"<p>basically create baseline, meet the baseline, increase baseline -&gt; ratcheting your security to not backslide metrics:      building metrics product security primitives kpi infosec org scorecard proactive efficiency:      \u201cwhy not ask ourselves how the team would cope if the workload went up another 30%, but bad financial results precluded any team growth? It's actually fun to think about such hypotheticals ahead of the time - and hey, if the ideas sound good, why not try them out today?\u201c from here evangelism: use this two questions: how'll we get hacked, and why security matters.</p>","tags":["cloudsec","MOC"]},{"location":"cloud-security/#other-categories-of-cloudsec-program","title":"other categories of cloudsec program","text":"<p>These don't fit, will probably moved to best practices</p>","tags":["cloudsec","MOC"]},{"location":"cloud-security/#invariants","title":"invariants","text":"<p>enforce/ alert on things that should always or never be true. idea is if there is no need for context (these things should always or never), no need for sec team time</p>","tags":["cloudsec","MOC"]},{"location":"cloud-security/#aws-policy","title":"aws-policy","text":"<p>example: aws scp, examples: rami scps</p> <p>alex smolen chris farris</p>","tags":["cloudsec","MOC"]},{"location":"cloud-security/#service-allowlisting","title":"service-allowlisting","text":"<p>basically do what GCP is by default. that is deny service unless it is in allow list. this also works for regions too (same thing invariants some regions that will never be used)</p> <p>more here: rami allowlisting</p>","tags":["cloudsec","MOC"]},{"location":"cloud-security/#vulnerability-and-asset-management","title":"vulnerability-and-asset-management","text":"","tags":["cloudsec","MOC"]},{"location":"cloud-security/#asset-inventory","title":"asset-inventory","text":"","tags":["cloudsec","MOC"]},{"location":"cloud-security/#hygiene","title":"hygiene","text":"<p>ownership issue; unused asset --&gt; use financial issue finops</p>","tags":["cloudsec","MOC"]},{"location":"cloud-security/#vuln-management","title":"vuln-management","text":"","tags":["cloudsec","MOC"]},{"location":"cloud-security/#cheatsheet","title":"cheatsheet","text":"<p>use these to help structure your vulns cloud conformity cloudsec atlas</p>","tags":["cloudsec","MOC"]},{"location":"cloud-security/#iam","title":"iam","text":"","tags":["cloudsec","MOC"]},{"location":"cloud-security/#least-privilege","title":"least-privilege","text":"<p>do we need absolute least priv. or good enough for human, because the needs changes. try service level least privileges, but maybe yes on least priv on crown jewels </p>","tags":["cloudsec","MOC"]},{"location":"cloud-security/#infra-access","title":"infra-access","text":"<ul> <li>use ssm to access instances</li> <li>use proxy/ wireguard</li> </ul>","tags":["cloudsec","MOC"]},{"location":"cloud-security/#services-identity","title":"services-identity","text":"<ul> <li>clean up unused services periodically. use steampipe here</li> <li>use imdsv2 for legacy instances</li> </ul>","tags":["cloudsec","MOC"]},{"location":"cloud-security/#detection","title":"detection","text":"","tags":["cloudsec","MOC"]},{"location":"cloud-security/#state-of-the-cloud","title":"state-of-the-cloud","text":"","tags":["cloudsec","MOC"]},{"location":"cloud-security/#big-picture-of-attack-vector-and-remediation","title":"big picture of attack vector and remediation","text":"","tags":["cloudsec","MOC"]},{"location":"cloud-security/#threat-model-based-off-uctm-httpssecurosiscomwp-contentuploads202404uctm_v_10pdf","title":"threat model based off UCTM https://securosis.com/wp-content/uploads/2024/04/UCTM_v_1.0.pdf","text":"<p>That is why we call this the Universal Cloud Threat Model. It identifies the commonalities all organizations face equally based on cloud usage \u2014 regardless of size, vertical, or nationality. We call these the \u201c90% of attacks experienced by 90% of organizations using the cloud</p> <ul> <li>threat model is \"custom\" for cloud</li> <li>basically goes: vector -&gt; sequence -&gt; objectives</li> <li>for instance.<ul> <li>vector<ul> <li>Lost, stolen, or exposed credentials </li> <li>Publicly exposed resources </li> <li>Credentials exposed via application security flaws</li> </ul> </li> <li>sequence<ul> <li>gain access via creds.</li> <li>enumerate</li> <li>start compute, inject mining via ssm</li> </ul> </li> <li>objectives<ul> <li>financial gain</li> </ul> </li> </ul> </li> </ul>","tags":["cloudsec","MOC"]},{"location":"cloud-security/#remediate-with","title":"remediate with","text":"","tags":["cloudsec","MOC"]},{"location":"cloud-security/#lost-stolen-or-exposed-credentials","title":"Lost, stolen, or exposed credentials","text":"<ul> <li>Reduce or eliminate static credentials and tokens for the cloud management plane. Where possible use alternatives like IAM Roles and Azure Managed Identities. Automation is your friend. There are plenty of free and commercial tools to hunt these down. </li> <li>Scan code for stored credentials in CI/CD pipelines and repositories, even if they are private. </li> <li>Require MFA for all human access, even when using API keys. </li> <li>Limit the duration of temporary access credentials so they expire after only a few hours. </li> <li>Migrate administrators and highly-privileged access to Just in Time access and/or use hardware tokens (e.g., Yubikeys). </li> <li>Implement a \u201cdata perimeter\u201d (this can be difcult in established enterprises, but can be very effective, even if only some basics are implemented).</li> </ul>","tags":["cloudsec","MOC"]},{"location":"cloud-security/#publicly-exposed-resources","title":"Publicly exposed resources","text":"<ul> <li>Use your cloud service provider\u2019s built-in assessment tools or a free or third-party scanner to identify public resources.  The key is sufficient coverage and act on results.</li> <li>Use your cloud provider\u2019s policy tools (guardrails) to prevent the creation of public resources where possible. For example Azure Policy, AWS Service Control Policies, and AWS Block Public Access for S3</li> <li>Automated remediation if you can't block via guardrails.</li> </ul>","tags":["cloudsec","MOC"]},{"location":"cloud-security/#credentials-exposed-via-application-security-flaws","title":"Credentials exposed via application security flaws","text":"<ul> <li>Reduce the exposure of applications to the public Internet. Place compute resources behind load balancer which only allow specific API routes.</li> <li>Do not give applications highly privileged access policies. IAM policies for applications should explicitly enumerate the resources each application needs to access. </li> <li>Avoid using AWS policies such as FullAccess and Basic Roles in GCP. Your tools (free or commercial) can help identify these. </li> <li>Scan code in CI/CD pipelines for static credentials. </li> <li>Ensure that access to the Instance Metadata Service requires authentication headers and limits the number of network hops permitted. For example require IMDSv2 on AWS. </li> <li>Use a WAF to mitigate undifferentiated application layer attacks. </li> <li>If your cloud provider offers credential misuse detection (e.g., session credentials used from someplace where the session didn\u2019t originate), use it. These aren\u2019t perfect and only catch these attacks sometimes, but they can really help. AWS GuardDuty is one option.</li> <li>While challenging and complex, implementing a data perimeter is one of the best defenses for this. Prioritize this option if you are the target of differentiated attacks.</li> <li>[ ] research on data perimeter practical\ud83d\udd3c </li> </ul>","tags":["cloudsec","MOC"]},{"location":"cloud-security/#unpatched-vulnerabilities-and-zero-days-in-overly-exposed-systems","title":"Unpatched vulnerabilities and zero-days in overly exposed systems","text":"<ul> <li>Minimize the number of systems which are exposed to the entire Internet. But we understand some of these systems are exposed to the Internet for legitimate reason, such as VPN servers and jump boxes, which you cannot always eliminate like the inadvertently exposed public resources mentioned earlier. You should still scan them and know where and how they are configured.<ul> <li>see your CWPP, or CNAPP, or CSP for this.</li> </ul> </li> <li>For containers consider using a container security platform or your cloud provider's container scanning features. Make sure your tool can identify vulnerabilities in running containers, not just images in storage \u2014 or can identify which containers are running vulnerable images.</li> <li>Enable your cloud provider\u2019s threat detection service (e.g., GuardDuty), which can help detect cryptomining; it is a common result of this attack vector.</li> <li>Exposed systems should never hold static credentials and should have least-privilege IAM permissions. We know this is hard, but if you are going to stick a target on the Internet, don\u2019t be surprised if someone takes you up on your offer. At least try to minimize the potential damage.</li> <li>Develop SBOM capabilities to discover and respond to zero-day threats when they arise quickly.</li> </ul>","tags":["cloudsec","MOC"]},{"location":"cloud-security/#denial-of-service-attacks","title":"Denial of Service attacks","text":"<ul> <li>Never expose workloads directly to the Internet. Even when they need to be exposed, stick them behind a load balancer, Content Delivery Network (CDN), or similar insulating service.</li> <li>For critical workloads/applications plan for DoS attacks and use standard precautions, such as a service from your CSP or a third-party vendor (AWS shield advance; Google cloud armour)</li> </ul>","tags":["cloudsec","MOC"]},{"location":"cloud-security/#supply-chain-compromise","title":"Supply chain compromise","text":"<ul> <li>use base trusted image, packages from trusted sources</li> <li>SBOM</li> <li>use Software Composition Analysis SCA</li> </ul>","tags":["cloudsec","MOC"]},{"location":"cloud-security/#cloud-detection-catalogue","title":"cloud-detection-catalogue","text":"<p>aws-detection-catalogue</p>","tags":["cloudsec","MOC"]},{"location":"cloud-security/#detection-response","title":"detection-response","text":"<p>aws-detect</p>","tags":["cloudsec","MOC"]},{"location":"cloud-security/#protect","title":"protect","text":"<p>aws-protect</p>","tags":["cloudsec","MOC"]},{"location":"cloud-security/#references-and-related","title":"references-and-related","text":"<p>ramimac 10x your cloud steampipe ramimac</p>","tags":["cloudsec","MOC"]},{"location":"cloud-threat-hunt/","title":"about","text":""},{"location":"cloud-threat-hunt/#principles","title":"principles","text":"<ul> <li>[ ] to be populated\ud83d\udd3d </li> </ul>"},{"location":"cloud-threat-hunt/#hunt-ideas","title":"hunt-ideas","text":""},{"location":"cloud-threat-hunt/#amazon-iam-following-attackers-cloudtrail-in-aws-methodology-and-findings-in-the-wild-datadog-security-labs-datadog-2023-th","title":"Amazon IAM [[Following attackers\u2019 (Cloud)trail in AWS Methodology and findings in the wild   Datadog Security Labs | datadog 2023 TH]]","text":"<ul> <li>High volumes of <code>access denied</code> errors from a specific identity</li> <li>IAM user creation events from EC2 instances (where the role session name starts with <code>i-</code>)</li> <li><code>Access denied</code> errors that occurred when creating an IAM user, especially when the same IAM user name was attempted to be created across multiple environments</li> <li>IAM user creation events from identities that had never created IAM users in the past</li> <li>IAM user names with grammatical errors or slight deviations of a common word</li> </ul>"},{"location":"cloud-threat-hunt/#reference-and-related","title":"reference-and-related","text":"<p>[[infosec-compendiums|infosec-compendiums]]</p>"},{"location":"cloudfront%20log/","title":"Related notes and references","text":"<p>[[aws-detect-and-response]]</p>"},{"location":"cloudfront%20log/#cloudfront","title":"CloudFront","text":"<p>CloudFront is AWS\u2019 content delivery network. CloudFront has the option to log to an S3 bucket or real-time logging if needed via a Firehose stream.</p> <p>What does it log? [[How to be IR Prepared in AWS - Cado Security  Cloud Forensics &amp; Incident Response#CloudFront]] CloudFront logs detailed information about every user request that CloudFront receives.</p> <p>Where does it log to? [[How to be IR Prepared in AWS - Cado Security  Cloud Forensics &amp; Incident Response#CloudFront]] Logs are stored in an S3 bucket, or for real-time logs in the Kinesis Firehose data stream.</p> <p>How do I enable it? [[How to be IR Prepared in AWS - Cado Security  Cloud Forensics &amp; Incident Response#CloudFront]] CloudFront logs are not enabled by default. To enable CloudFront access logs: 1. Access the CloudFront console. 2. Choose the distribution you want to update. 3. On the General tab, under Settings, choose Edit. 4. For Standard logging, select On. 5. Choose the S3 bucket where you want CloudFront to deliver the log files. You can specify an optional prefix for the file names. 6. Choose Save changes. To enable real-time logs: 1. Access the CloudFront console. 2. From the left-hand navigation, select Logs. 3. Choose the Real-time configurations tab. 4. Choose Create configuration. 5. For Sampling rate, enter the percentage of requests for which you want to receive real-time log records. 6. For Fields, choose the specific fields that you want to receive in the log records. In the Choose options dropdown list, select any fields that you want to include in the configuration. 7. Choose one or more Kinesis data streams to receive real-time logs.Note: CloudFront real-time logs are delivered to the data stream of your choice in Amazon Kinesis Data Streams. To read and analyze your real-time logs, you can build your own Kinesis data stream consumer. Or, use Amazon Kinesis Data Firehose to send the log data to Amazon S3, Amazon Redshift, Amazon OpenSearch Service, or a third-party log processing service. 8. For IAM role, choose Create new service role for the console to create an IAM role for you. To use this option, you must have permission to create IAM roles.or-Use an existing IAM role. 9. (Optional) In the Distribution section, choose a CloudFront distribution and cache behavior to attach to the real-time log configuration. 10. Choose Create configuration.</p> <p>How do I access the logs?[[How to be IR Prepared in AWS - Cado Security  Cloud Forensics &amp; Incident Response#CloudFront]] The standard logs can be downloaded from the S3 bucket. Accessing the real time logs is dependent on the endpoint of your Amazon Kinesis Data Streams.</p>"},{"location":"cloudtrail/","title":"CloudTrail","text":"<p>CloudTrail monitors and logs the API activity. </p> <p>CloudTrail and IAM are linked, and understanding one helps with the other. Nearly Every API call to AWS is authenticated, and all API calls must be authorized. This is done via IAM. [[Incident Response in AWS - Chris Farris]]</p> <p>if you have aws-organization on, it is better to enable organizational-cloudtrail</p>","tags":["cloudsec"]},{"location":"cloudtrail/#cloudtrail-best-practice","title":"cloudtrail-best-practice","text":"<p>cloudtrail-best-practice</p> <ul> <li>[ ] to read cloudtrail best practice\ud83d\udd3c </li> </ul>","tags":["cloudsec"]},{"location":"cloudtrail/#organization-policy-and-cloudtrail","title":"Organization Policy and CloudTrail","text":"<p>Resource Control Policies  need to enable very expensive CloudTrail DataEvents and review the vast data produced.  While Service Control Policy API calls is readily available With service control policies, it is possible to review CloudTrail to determine who may be calling the specific actions that will be denied. [[Defining Security Invariants  PrimeHarbor]]</p>","tags":["cloudsec"]},{"location":"cloudtrail/#default-settings","title":"Default settings","text":"<p>Cloudtrail is always on by default, but only storing for 90d. this can be accessed via Event history. To store more set up a trail and use S3 (make sure multi trail or organization trail).</p> <p>AWS CloudTrail (AWS's logging for API\u00a0calls) do not log data events.  AWS CloudTrail data management events NOT LOGGED: - s3:PutObject - s3:ListObjects - s3:CopyObject - s3:GetObject However, when TA use S3:ListBuckets this is logged.</p> <p>While it's possible to enable data event logging, this can get expensive due to additional charges applying for data events and the high-volume nature of data events. [[Ransomware in AWS S3 SSE-C#Observations and Questions on Ransomware in S3]]</p>","tags":["cloudsec"]},{"location":"cloudtrail/#what-does-it-log","title":"What does it log?","text":"<p>[[How to be IR Prepared in AWS - Cado Security  Cloud Forensics &amp; Incident Response#AWS CloudTrail]] CloudTrail records API activity such as the user agent, IP address, IAM user or role ARN, as well as any service-specific details about the request</p> <p>Not all authenticated events are logged in CloudTrail.  Only the management events/ control plane events. logging management events If you want to track access to specific Data sources, like S3, DynamoDB, or Lamba Functions, you need to enable Data Events for CLoudTrail AWS IR</p> <p>Here is how to log data events logging data events</p> <p>Use event selector to specify <code>ReadOnly</code>\u00a0or\u00a0<code>WriteOnly</code> and advance event selector to specify<code>eventSource</code>,\u00a0<code>eventName</code>\u00a0and\u00a0<code>eventCategory</code></p>","tags":["cloudsec"]},{"location":"cloudtrail/#where-does-it-log-to","title":"Where does it log to?","text":"<p>[[How to be IR Prepared in AWS - Cado Security  Cloud Forensics &amp; Incident Response#AWS CloudTrail]]</p> <p>CloudTrail is enabled by default and will preserve the past 90 days of activity.  However, as best practice it should be configured to also send Logs to an S3 bucket for longer term storage. There is also the option to send logs to CloudWatch.</p> <p>Data event is really voluminous, so don\u2019t feed them into a SEIM. Instead, keep them in S3 because for when needed (occasional cost optimization research or in the event of an incident).</p>","tags":["cloudsec"]},{"location":"cloudtrail/#how-do-i-enable-it","title":"How do I enable it?","text":"<p>[[How to be IR Prepared in AWS - Cado Security  Cloud Forensics &amp; Incident Response#AWS CloudTrail]] CloudTrail logs are enabled by default. To enable the ability to send logs to an S3 bucket for longer term storage: - First create an S3 bucket - Then go to the AWS Management Console, and select the CloudTrail service. - From the cloud trail dashboard go to CloudTrail Insights &gt; Create a trail, give the trail a name and configure its attributes; for storage select the S3 you created earlier. - Finally choose your log events, management events and data events. Review and create your trail.</p> <p>These events capture activity made through the AWS Management Console, AWS Command Line Interface, and AWS SDKs and APIs</p>","tags":["cloudsec"]},{"location":"cloudtrail/#how-do-i-access-the-logs","title":"How do I access the logs?","text":"<p>[[How to be IR Prepared in AWS - Cado Security  Cloud Forensics &amp; Incident Response#AWS CloudTrail]]</p> <p>Logs can be accessed and downloaded via the cloud trail console: https://console.aws.amazon.com/cloudtrail/home/.To view recent events, go to Event History.</p> <p>To query CloudTrail events in S3, you can use Athena. I\u2019ll point you at the\u00a0AWS Documentation for setting this up, they have an excellent explanation.</p> <p>The following AWS managed policies are available for CloudTrail:</p> <ul> <li>AWSCloudTrail_FullAccess \u2013 This policy provides full access to CloudTrail actions on all CloudTrail resources. This policy provides the required permissions to create, update, and delete CloudTrail trails, event data stores, and channels as well as permissions to manage the Amazon S3 bucket. It doesn\u2019t provide permissions to delete the Amazon S3 bucket, the log group for CloudWatch Logs, or an Amazon SNS topic. Users with this role can turn off or reconfigure important auditing functions in their AWS accounts so use of this policy should be closely controlled and monitored.</li> <li>AWSCloudTrail_ReadOnlyAccess \u2013 This policy grants permissions to view the CloudTrail console, including recent events and event history. This policy also allows you to view existing trails, event data stores, and channels.</li> </ul>","tags":["cloudsec"]},{"location":"cloudtrail/#see-also-cloudtrail-and-centralized-root-management-aws-protectaws-centralized-root-managementaws-protect","title":"See also CloudTrail and centralized root management: [[aws-protect#AWS centralized root management|AWS protect]]","text":"","tags":["cloudsec"]},{"location":"cloudtrail/#aws-cloudtrail-limitation","title":"aws-cloudtrail-limitation","text":"<p>there is quota limit for cloudtrail, you can see here aws cloudtrail limit</p>","tags":["cloudsec"]},{"location":"cloudtrail/#references","title":"References","text":"<p>AWS-IR aws-detect-and-response [[AWS CloudTrail Documentation]]</p>","tags":["cloudsec"]},{"location":"cloudwatch/","title":"Related notes and references","text":"<p>[[aws-detect-and-response]]</p>"},{"location":"cloudwatch/#cloudwatch","title":"CloudWatch","text":"<p>Almost all AWS services support sending logs to CloudWatch. </p> <p>CloudWatch monitors your AWS resources and the applications that you run on AWS in real time. You can collect and track metrics, create customized dashboards, and set alarms. Making it both a repository and a source for logs from across AWS. </p> <p>With CloudWatch, you have the option to either manually export the logs to S3 storage or stream them directly to other places via other AWS services. [[How to be IR Prepared in AWS - Cado Security  Cloud Forensics &amp; Incident Response#CloudWatch]]</p>"},{"location":"cloudwatch/#what-does-it-log","title":"What does it log?","text":"<p>CloudWatch will log whatever logs other services are configured to send to it. [[How to be IR Prepared in AWS - Cado Security  Cloud Forensics &amp; Incident Response#CloudWatch]]</p>"},{"location":"cloudwatch/#imdsv2-and-cloudwatch","title":"IMDSv2 and CloudWatch","text":"<p>For IMDSv2 enforcement, you can review the CloudWatch Metric\u00a0<code>MetadataNoToken</code>\u00a0to see how many API calls still use the old system.</p>"},{"location":"cloudwatch/#where-does-it-log-to","title":"Where does it log to?","text":"<p>CloudWatch can send logs to many different places, Manually there is the option to send the logs to an S3 bucket. If a subscription is configured, then there is the option to send the logs to Lambda, Kinesis Data Stream, or Kinesis Data Firehose Stream. [[How to be IR Prepared in AWS - Cado Security  Cloud Forensics &amp; Incident Response#CloudWatch]]</p>"},{"location":"cloudwatch/#how-do-i-enable-it","title":"How do I enable it?","text":"<p>These logs are not enabled by default, all options either manual or subscription must be configured. The method of configuring Logs to be sent to CloudWatch is dependent on the service you are looking to send logs from. A full list of services that support sending logs to CloudWatch can be found here, along with documentation on configuring them. [[How to be IR Prepared in AWS - Cado Security  Cloud Forensics &amp; Incident Response#CloudWatch]]</p>"},{"location":"cloudwatch/#how-do-i-access-the-logs","title":"How do I access the logs?","text":"<p>To manually export logs to an S3 bucket, AWS provides this guide. To configure real time access via subscriptions, AWS provides this guide. [[How to be IR Prepared in AWS - Cado Security  Cloud Forensics &amp; Incident Response#CloudWatch]]</p>"},{"location":"detection-engineering-data-source/","title":"Related notes:","text":"<p>[[detection-engineering]] practical threat detection engineering:</p>"},{"location":"detection-engineering-data-source/#summary","title":"Summary","text":"<p>This note list data sources for SIEM/ SOAR</p>"},{"location":"detection-engineering-data-source/#types-of-assets","title":"Types of assets","text":""},{"location":"detection-engineering-data-source/#windows","title":"Windows","text":"<p>Common windows list of data sources: - Application log - Security log - System log - Powershell log - Sysmon log</p> <p>PowerShell event logs only include full command lines if PowerShell Script Block Logging is enabled. It is disabled by default and must be enabled via a Group Policy Object or the Registry. </p>"},{"location":"detection-engineering-data-source/#linux","title":"Linux","text":"<p>Linux logs commonly used: - /var/log/syslog or / var/log/messages: system activty data - /var/log/auth.log or / var/log/secure: security log - /var/log/cron: scheduled task - /var/log/faillog: failed logins - /var/log/audit/audit.log: auditd rules based log</p>"},{"location":"detection-engineering-data-source/#network","title":"Network","text":"<ul> <li>Packet captures: expensive, low priority. e.g. using packetbeat</li> <li>Network devices: logs from network devices, commonly used syslog to ship. e.g. log are flow data; another one is alerts from network security appliances</li> </ul>"},{"location":"detection-engineering-data-source/#application","title":"Application","text":"<p>Application logs may vary by name, but commonly app logs have these function: - Access, authentication and authorization logs: who logged in/out and when, whether it was a successful login attempt, and what operations were performed - Change log: e.g. config change, permission change - Error log - Availability log</p>"},{"location":"detection-engineering-data-source/#cloud","title":"Cloud","text":"<p>read more on AWS: [[aws-detect-and-response]]</p>"},{"location":"detection-engineering-data-source/#security-tooling","title":"Security tooling","text":"<ul> <li>Endpoint solution (EDR, endpoint protection) logs: alert log based off rules</li> <li>Network protection (Zeek, suricata, see also [[detection-engineering-data-source#Network]]): alert based off rules. these appliances also have detection development capability, thus detection engineer usually can also tinker with the rule that fire alert</li> </ul>"},{"location":"detection-engineering-data-source/#data-sources-challenges","title":"Data sources challenges","text":""},{"location":"detection-engineering-data-source/#completeness","title":"Completeness","text":"<p>We do not want to waste storage resources and bandwidth on data sources that won\u2019t add value to our investigation due to the data they expose For example, if a system provides logs showing a network connection was established but there are no details on the source/destination of the connection with contextless timestamps and ambiguous time zones, there is likely not much that can be used from that to develop a quality detection.</p>"},{"location":"detection-engineering-data-source/#quality","title":"Quality","text":"<p>data should be reliable and relevant. another aspect is the format of the data.</p>"},{"location":"detection-engineering-data-source/#timeliness","title":"Timeliness","text":"<p>this covers delays of sending data, if the data is pre-process that cause delay?</p>"},{"location":"detection-engineering-data-source/#coverage","title":"Coverage","text":"<p>data should provide cover for what detection we aim to build</p>"},{"location":"detection-engineering-data-source/#understanding-your-data-sources","title":"Understanding your data sources","text":"<p>Some points to help understand your sources: - Does the data source cover our detection needs? we should already have the technical needs for our detection when we ask these questions. Read more on [[detection-engineering#Investigate]] - What method is required to retrieve logs from the data source? API, Syslog, or something else?  - What format does the data source provide logs in?  - What time zone is the data source using for their timestamps? - Who is the point of contact for the data source that we need logs from?  - What are the retention policies of the data source?  - Does the detection engineering team have access to retrieve logs from the source?  - What is the delay between an event occurring and it being received in the detection? - Can the logging configuration be modified to improve the data being received?</p> <p>note about retention:  sometimes the data source owner fail to understand that the goal of detection is not storing log, and this blur the line between their log retention policy with detection needs retention policy. be concise and clear to differentiate this when communicating data needs.</p>"},{"location":"detection-engineering/","title":"detection-engineering","text":"","tags":["detection-engineering"]},{"location":"detection-engineering/#definition","title":"definition","text":"<p>practical threat detection engineering Detection engineering definition Detection engineering can be defined as a set of processes that enable potential threats to be detected within an environment. These processes encompass the end-to-end life cycle, from collecting detection requirements, aggregating system telemetry, and implementing and maintaining detection logic to validating program effectiveness.</p>","tags":["detection-engineering"]},{"location":"detection-engineering/#good-detection","title":"good-detection","text":"<p>practical threat detection engineering</p> <p>Evaluation criteria to judge good detection - the ability to detect adversary     - detection coverage     - detection durability - the cost of that ability to the organization - the cost to the adversary to evade detection</p>","tags":["detection-engineering"]},{"location":"detection-engineering/#the-ability-to-detect-adversary","title":"the ability to detect adversary","text":"<p>can be broken to detection coverage and detection durability. Coverage is scope of activity that detection identifies. (example coverage over MITRE). While durability is how long the detection to be effective. Increasing a detection\u2019s coverage by detecting multiple procedures associated with a technique or creating a detection that works across multiple techniques often increases the complexity of the detection but can also improve a detection\u2019s durability.</p>","tags":["detection-engineering"]},{"location":"detection-engineering/#the-cost-of-that-ability-to-the-organization","title":"the cost of that ability to the organization","text":"<p>this covers the creation, running, and maintenance of detections, the resources spent reviewing associated alerts, and the actions taken based on those alerts some factor that contribute: - complexity: how hard to understand the detection for maintenance - staleness: continued effectiveness  - confidence: how noisy is the detection (false positive rate) - impact: potential impact of the detection - actionability: how easy it is for a SOC analyst to leverage the detection to either further analyze the threat or remediate it. - specificity: As an example, a machine learning model may provide increased coverage in detection with a high confidence level but may be unable to explain specifically why the alert was created For example, a detection might identify reconnaissance scanning of the network. The lack of actionability on this activity, despite the confidence in the detection, might result in the noisiness of the detection being unacceptable.For example, a detection might identify reconnaissance scanning of the network. The lack of actionability on this activity, despite the confidence in the detection, might result in the noisiness of the detection being unacceptable.</p>","tags":["detection-engineering"]},{"location":"detection-engineering/#cost-to-the-adversary","title":"cost to the adversary","text":"<p>this is related to the pyramid of pain.</p>","tags":["detection-engineering"]},{"location":"detection-engineering/#advantages-of-detection-program","title":"advantages-of-detection-program","text":"<p>practical threat detection engineering key advantages: </p> <ul> <li>detection bundles that come with vendor is one size fit all. Homebrew detection will get specific with your need</li> <li>standardized detection rule and version controlled rule</li> <li>automated testing</li> <li>cost and time saving</li> </ul>","tags":["detection-engineering"]},{"location":"detection-engineering/#standardized-detection-rule-and-version-controlled","title":"Standardized detection rule and version controlled","text":"<p>detection program will set standards for how detections are written. This allows the code to be easily understood and compatible with detection solutions. Also a detection repository should be leveraged, so code is version controlled, previewed and tested.</p>","tags":["detection-engineering"]},{"location":"detection-engineering/#automated-testing","title":"Automated testing","text":"<p>reduced the risk code introducing error into prod. automation also decrease time and cost for engineer vs manual testing.</p> <pre><code>- [ ] continue chapter 2 on practical threat detection book\n</code></pre>","tags":["detection-engineering"]},{"location":"detection-engineering/#types-of-rules","title":"types-of-rules","text":"<p>[[Atomic &amp; Stateful Detection Rules]]</p> <p>atomic detection: focus on single, isolated events or activities that can be identified as malicious or benign without further context. These are quick and precise but limited in scope. </p> <p>stateful detection: often called correlation rules, rely on analyzing multiple events over time to build context and detect patterns of malicious behavior. They offer more depth but come with added complexity. </p> <p>Simply put, atomic detections focus on identifying a single event as potentially harmful, while stateful rules analyze multiple events to reveal behaviors that might indicate a larger issue.</p>","tags":["detection-engineering"]},{"location":"detection-engineering/#life-cycle","title":"life-cycle","text":"<p>practical threat detection engineering</p> <pre><code>flowchart LR\n\nRequirement --&gt; Triage --&gt; Investigate --&gt; Develop --&gt; Test --&gt; Deploy\nInvestigate --&gt; Requirement\nDeploy --&gt; Develop\n</code></pre> <p>Continuous activity inside life cycle ^ContAct Aside from the life cycle, this activity is done continuously:  ^065d90 - Monitoring: know your current detection - Maintenance: see if there need to be update/ changes - Metrics: is it too noisy? is it too quite? how much is FP rate? performance of the detection - too much resource hogging?  - Validation: simulate or use detection assessment ^7db3dd</p>","tags":["detection-engineering"]},{"location":"detection-engineering/#requirement","title":"requirement","text":"<p>things to include in the requirement: requesting party, description, reason, exception, scope, evidence</p> <p>The requirement come from CTI, business requirement - legal, red team exercise, SOC request, and [[detection-engineering#^7db3dd| continous activity]].</p>","tags":["detection-engineering"]},{"location":"detection-engineering/#triage","title":"triage","text":"<p>output: triaged and prioritized requirements</p> <p>Triage the requirement using:  - severity of the threat     - is this an active exploit: log4j! (see common ways of judging exploit severity: is our estate affected, how easy it is to exploit, impact, is it currently happening, how fast to patch) - organizational alignment with the threat:  - detection coverage</p>","tags":["detection-engineering"]},{"location":"detection-engineering/#severity-of-the-threat","title":"severity of the threat","text":"<p>system of scoring that you assign to threat severity. e.g. CVSS, DREAD, NIST CMSS, custom?</p>","tags":["detection-engineering"]},{"location":"detection-engineering/#organizational-alignment","title":"organizational alignment","text":"<p>a scoring system that see if detection related to the threat is something we should worry about. e.g. 0 - threat is irrelevant, while 4 - threat specifically target your org.</p>","tags":["detection-engineering"]},{"location":"detection-engineering/#detection-coverage","title":"detection coverage","text":"<p>another scoring system. e.g. 0 - this technique detection have in depth coverage; 1 - this technique detection need update; 2 - this technique detection is not present  another point to think about is how the new requirement is an improvement of current detection</p>","tags":["detection-engineering"]},{"location":"detection-engineering/#investigate","title":"investigate","text":"","tags":["detection-engineering"]},{"location":"detection-engineering/#output","title":"output","text":"<p>Detection of technical specifications and data engineering requirements (if applicable). </p>","tags":["detection-engineering"]},{"location":"detection-engineering/#steps","title":"steps","text":"<ul> <li>identify data source: what is needed to detect the requirement, do we have this?</li> <li>determine indicator type: <ul> <li>atomic, behavior, hybrid and </li> <li>context: context is important! do you search IP in <code>src.ip</code> or <code>dst.ip</code>? or just <code>*.ip</code>. Also understand your environment for context. e.g. do you search for IP in your EDR telemetry? firewall? network appliances ? VPN logs?</li> </ul> </li> <li>research: identify attacker goals and TTP, see our current TTP coverage is this TTP already detected? can this requirement improve? do we need new one? think of variation of the techniques that needed to be detected.</li> <li>establish validation criteria: identify how to test detection</li> </ul> <p>read more on [[detection-engineering-data-source|data sources]]</p>","tags":["detection-engineering"]},{"location":"detection-engineering/#tools","title":"tools","text":"<p>Ticketing and communication system: take and document requirements. see if possible integration of both ticket and comm. system. Knowledge base: document requirement, detection, alert, etc. Standards: have a set of standards to communicate technical information, CVSS, MITRE, OCSF, etc.</p> <p>on Knowledge base system ^KnowledgeBaseNote KB system can be use to document requirements, detection, details of alert, playbook. Another important information to record is details of data source, this way an investigation phase on a data source do not need to be conducted again when a detection calls for the same data source.  Important that these knowledge base follow a certain nomenclatures/ standards in describing these data. ^a94351</p>","tags":["detection-engineering"]},{"location":"detection-engineering/#develop","title":"develop","text":"<p>output: detection code</p> <p>this step consist of: design, development, and unit testing. things to keep in mind:  - cost of detection. There are side to this point, you can see:     - do this detection need to run real-time? if not how many times a day should it run?     - how specific should the query be? overly specific will have true negative, and overly general will be too noisy/ false positive.     - these thing will also show up in next step i.e. testing     - [ ] is there any writing on cost of detection, false positive fatigue etc. \u23eb  - standards: this goes for details and wording in alert, this will determine how easy it is for SOC to action on.</p> <ul> <li>[x] continue from here on book detection eng. \u23eb \u2705 2025-02-10</li> </ul>","tags":["detection-engineering"]},{"location":"detection-engineering/#testing","title":"testing","text":"<p>Test-driven development is a software development technique that adapts well to this purpose. Tests are designed before development and are first added to the automated acceptance testing infrastructure. The development process starts with running the tests against your existing detection capabilities. This may result in you identifying already existing detection capabilities or confirming the failure of these tests, which identifies the need to create or update a detection. During the development process, these tests are continuously applied and used to influence the improvement of the detection</p> <p>In general, these ad hoc tests should keep the following goals in mind: - identify scenarios false positive - identify for evasion from detection - identify incomplete detection: These should highlight detection definitions that are too loosely defined and do not correctly identify all permutations of the event to be detected.</p>","tags":["detection-engineering"]},{"location":"detection-engineering/#deploy","title":"deploy","text":"<p>Output: Deployed detection code</p> <p>things to keep in mind:</p>","tags":["detection-engineering"]},{"location":"detection-engineering/#deployment-tags","title":"deployment tags","text":"<p>Use deployment tags to differentiate between deployed detection (e.g. experimental - not tested, tested - deployed; tested; LowPriority , stable - fully deployed)</p>","tags":["detection-engineering"]},{"location":"detection-engineering/#documentation-also-see-detection-engineeringa94351","title":"documentation (also see [[detection-engineering#^a94351]] )","text":"<p>Documentation should have a set of standards on what to document and how to document it. A minimal of these information should be available on documentation: - Information used to maintain detection     author, creation date and revision history, maturity (see [[detection-engineering#deployment tags]]), references - Information on the detection     name, description, TTP, tags, the detection, data sources - information on how to action on  detection     related detection (to help confirm true positive), investigation suggestion, remediation actions, false positive (what action is know false positive), severity, confidence</p>","tags":["detection-engineering"]},{"location":"detection-engineering/#maintain-coverage-map-see-detection-engineering065d90","title":"maintain coverage map (see [[detection-engineering#^065d90]])","text":"","tags":["detection-engineering"]},{"location":"detection-engineering/#detection-components","title":"detection-components","text":"<p>This is a simplified version of components on a detection</p> <ul> <li>Event forwarding: forward events from assets. e.g. beats, elastic agent. Another part of the component is the management of agent. e.g. fleet server</li> <li>Log collection and processing: this component collect and pre-process logs. e.g. elasticsearch, logstash</li> <li>Detection and detection development: this component provide detection and detection development capability. e.g. elasticsearch</li> <li>Monitoring and alerting: this component provide implementation of detection and interface for monitoring and alerting. e.g. Kibana</li> <li>Detection engineering pipeline<ul> <li>repository</li> <li>testing and validation</li> </ul> </li> <li>[ ] continue at page 193 practical threat detection eng. book\u23eb </li> </ul>","tags":["detection-engineering"]},{"location":"detection-engineering/#detection-validation","title":"detection-validation","text":"<p>we have looked at coverage as surface area (i.e. compare to mitre), another thing to look at it is durability. </p> <p>If a detection is identifying an indicator on the lower echelons of the pyramid of pain, or anywhere there is an almost infinite number of variations that the adversary can change to execute the attack, the durability is limited to the ops-tempo of the adversary changing that part of the attack. As an example, if your detection is limited to an IP address or domain, there are almost unlimited variations of the IPs or domains used by the adversary. The durability is thereby associated with how often the adversary changes this infrastructure.</p> <p>This is also related with technique and procedures and procedures variation. When validating, test if all procedures in a technique is covered, and test if procedures variation is covered. here it is in pseudocode:</p> <pre><code>If detection_of_procedureA OR detection_of_procedureB OR detection_ of_procedureC ALERT ON TechniqueXYZ.\n</code></pre> <p> practical threat detection engineering</p> <p>Based on those theses, when building detection: the indicator with the least amount of variability is the choke point for that procedure is the one we use to build detection, and this is also where our validation level should be.</p>","tags":["detection-engineering"]},{"location":"detection-engineering/#maturity-model","title":"maturity-model","text":"<p>[[maturity-model]] for detection engineering https://detectionengineering.io/ - [ ] read on [[Elastic releases the Detection Engineering Behavior Maturity Model \u2014 Elastic Security Labs]]</p>","tags":["detection-engineering"]},{"location":"detection-engineering/#reference-and-related","title":"reference-and-related","text":"<p>practical threat detection engineering</p>","tags":["detection-engineering"]},{"location":"ec2-logs/","title":"Related notes and references","text":"<p>[[aws-detect-and-response]]</p>"},{"location":"ec2-logs/#ec2-log","title":"EC2 Log","text":"<p>EC2 is AWS\u2019 Elastic compute offering, it supports systems level logging, allowing logs directly from the OS on the instance to be collected via the CloudWatch agent and stored in CloudWatch.</p>"},{"location":"ec2-logs/#what-does-it-log","title":"What does it Log?","text":"<p>[[How to be IR Prepared in AWS - Cado Security  Cloud Forensics &amp; Incident Response#EC2]] EC2 collects different system level logs depending on the operating system of the Instance. Below the default logs that the CloudWatch agent in an EC2 instance collects:</p> <p>For Amazon Linux / Red Hat Linux / Centos Linux / Ubuntu / SUSE Linux: <pre><code>/var/log/amazon/ssm/amazon-ssm-agent.log\n/var/log/amazon/ssm/errors.log\n/var/log/audit/audit.log\n/var/log/cloud-init-output.log\n/var/log/cfn-init.log\n/var/log/cfn-init-cmd.log\n/var/log/cloud-init.log (Amazon Linux 1 / Amazon Linux 2 only)\n/var/log/cron\n/var/log/maillog\n/var/log/messages\n/var/log/secure\n/var/log/spooler\n/var/log/yum.log\n/var/log/aws/ams/bootstrap.log\n/var/log/aws/ams/build.log\n/var/log/syslog\n/var/log/dpkg.log\n/var/log/auth.log\n/var/log/zypper.log\n</code></pre></p> <p>For Windows: <pre><code>SecurityEventLog\nSystemEventLog\nAmazonSSMAgentLog\nMicrosoftWindowsAppLockerMSIAndScriptEventLog\nMicrosoftWindowsAppLockerEXEAndDLLEventLog\nAmazonCloudWatchAgentLog\nEC2ConfigServiceEventLog (Windows Server 2012 R2 Only)\nApplicationEventLog\nAmazonCloudFormationLog\nMicrosoftWindowsGroupPolicyOperationalEventLog\nAmazonSSMErrorLog\n</code></pre></p>"},{"location":"ec2-logs/#where-does-it-log-to","title":"Where does it log to?","text":"<p>[[How to be IR Prepared in AWS - Cado Security  Cloud Forensics &amp; Incident Response#EC2]] Logs from EC2 instances are sent to CloudWatch, and stored in a CloudWatch Log group with the same name as the instance.</p>"},{"location":"ec2-logs/#how-do-i-enable-it","title":"How do I enable it?","text":"<p>[[How to be IR Prepared in AWS - Cado Security  Cloud Forensics &amp; Incident Response#EC2]] To enable the logging, CloudWatch agent must be installed. AWS provides a guide on this here.</p>"},{"location":"ec2-logs/#how-do-i-access-the-logs","title":"How do I access the logs?","text":"<p>[[How to be IR Prepared in AWS - Cado Security  Cloud Forensics &amp; Incident Response#EC2]] Logs can be accessed via CloudWatch</p>"},{"location":"guardduty/","title":"Related notes","text":"<p>[[aws-detect-and-response]]</p>","tags":["AWS"]},{"location":"guardduty/#guardduty","title":"GuardDuty","text":"<p>Amazon GuardDuty is AWS\u2019s managed threat detection service It leverages three primary data feeds: - CloudTrail - VPC Flow Logs - DNS Query Logs  The findings it produces are either around an Identity or a Network-based device. The findings can also be explicit or anomaly-based. With Delegated Admin capabilities, GuardDuty can easily manage and deployed via AWS Organizations. [[Incident Response in AWS - Chris Farris]]</p> <p>GuardDuty can be access from AWS RDSDB, this is seen as part of defense evasion from  invictus-IR article [[cloud-detection-catalogue#defense-evasion techniques]]</p>","tags":["AWS"]},{"location":"guardduty/#guardduty-coverage","title":"GuardDuty coverage","text":"<p>a list of GuardDuty finding types</p>","tags":["AWS"]},{"location":"guardduty/#cost","title":"Cost","text":"<p>As with other Security investment, it is ROI sensitive.</p> <p>GuardDuty cost can be challenging due to the rates are based on amount of analyzed data from various, unpredictable sources like CloudTrail, Flow Logs, DNS.</p>","tags":["AWS"]},{"location":"guardduty/#latency","title":"Latency","text":"<p>Another problem with GuardDuty is the finding will obviously have delay. Read more on this from tracebit</p>","tags":["AWS"]},{"location":"guardduty/#tools","title":"Tools","text":"<p>amazon-guardduty-tester: This repository contains scripts and guidance that can be used as a proof-of-concept to generate Amazon GuardDuty findings related to real AWS resources</p>","tags":["AWS"]},{"location":"guardduty/#references","title":"References","text":"<p>tracebit</p>","tags":["AWS"]},{"location":"infosec-compendiums/","title":"infosec-compendiums","text":"<p>Our job is to manage and reduce risks to whatever level our organization decides it needs, while minimizing friction. It\u2019s a balance. rmogull</p>","tags":["MOC"]},{"location":"infosec-compendiums/#govern","title":"govern","text":"<p>[[maturity-model]]</p>","tags":["MOC"]},{"location":"infosec-compendiums/#identify","title":"identify","text":"<p>[[vulnerability-management]]</p>","tags":["MOC"]},{"location":"infosec-compendiums/#protect","title":"protect","text":"<p>[[threat-modelling]] [[aws-protect]] appsec program</p>","tags":["MOC"]},{"location":"infosec-compendiums/#detect","title":"detect","text":"<p>[[detection-engineering]] [[aws-detect-and-response]] [[cloud-detection-catalogue]]</p>","tags":["MOC"]},{"location":"infosec-compendiums/#response","title":"response","text":"<p>[[aws-detect-and-response]]</p>","tags":["MOC"]},{"location":"infosec-compendiums/#recover","title":"recover","text":"","tags":["MOC"]},{"location":"infosec-compendiums/#other","title":"other","text":"<p>[[cloud-security]]</p>","tags":["MOC"]},{"location":"infosec-compendiums/#references-and-related","title":"references-and-related","text":"<p>BSidesSF 2020 - How to 10X Your Company\u2019s Security - clint gibbler</p>","tags":["MOC"]},{"location":"lambda-log/","title":"Related notes and references","text":"<p>[[aws-detect-and-response]]</p>"},{"location":"lambda-log/#lambda","title":"Lambda","text":"<p>AWS Lambda is a compute service that lets you run code without provisioning or managing servers. It supports Logging of application logs from the running code. Lambda Logs Viewed in CloudWatch What does it log? [[How to be IR Prepared in AWS - Cado Security  Cloud Forensics &amp; Incident Response#Lambda]] Lambda logs any application logs sent to stdout/stderr from your running code.</p> <p>Where does it log to? [[How to be IR Prepared in AWS - Cado Security  Cloud Forensics &amp; Incident Response#Lambda]] Logs are sent to CloudWatch.</p> <p>How do I enable it? [[How to be IR Prepared in AWS - Cado Security  Cloud Forensics &amp; Incident Response#Lambda]] They are enabled by default, however you must ensure that your function has permission to create log groups and/or streams</p> <p>How do I access the logs?[[How to be IR Prepared in AWS - Cado Security  Cloud Forensics &amp; Incident Response#Lambda]] Logs can be accessed via the CloudWatch console: 1. Open the Functions page of the Lambda console. 2. Choose a function. 3. Choose Monitor. 4. Choose View Logs in CloudWatch.</p>"},{"location":"maturity-model/","title":"Maturity Model","text":"<p>maturity-model </p>","tags":["maturity-model","MOC"]},{"location":"maturity-model/#detection-engineering","title":"detection engineering","text":"<p>Maturity model for detection engineering: [[detection-engineering#maturity model]]</p>","tags":["maturity-model","MOC"]},{"location":"maturity-model/#aws-security","title":"AWS Security","text":"<p>AWS security maturity model - Scott Piper</p>","tags":["maturity-model","MOC"]},{"location":"microsoft-defender-suite/","title":"about","text":"<p>This is basically note on how to setup, work with and improve microsoft defender suite I steal a lot of this from GSD, a very comprehensive guide!</p> <p>more stuff on ms. entra and ms. purview</p> <p>high level stuff</p> <pre><code>graph LR\n\nA[MDE] --&gt; |detect app|B[MDCA]\nB --&gt; |via XDR|C[sentinel]\nA --&gt; |via XDR|C\nB --&gt; |govern app|A</code></pre> assets govern identify protect detect respond recover identity MDI MDI, CA MDI MDI endpoint MDE MDE MDE MDE cloud MDCA policy MDCA, MDE MDCA, MDE MDCA, MDE apps <p>stuff to learn</p> <ul> <li>[ ] try azure</li> <li>[ ] az 500 microsoft  or microsoft  or this roadmap?</li> <li>[ ] try ms graph https://www.youtube.com/watch?v=9qIgyYLjHnU</li> <li>[ ] try purview</li> <li>[ ] read purview, MIP</li> <li>[ ] read MDI, MDE, MDO</li> <li>[ ] find baseline for azure</li> <li>[ ] read azure vs aws https://nira.com/aws-security-vs-azure-security/#:~:text=AWS%20and%20Azure%20are%20almost,services%20and%20options%20than%20Azure. https://www.aquasec.com/cloud-native-academy/cspm/azure-security-vs-aws-security/ https://www.wiz.io/academy/azure-security-vs-aws-security https://medium.com/@leasepacket/aws-security-vs-azure-security-a-comprehensive-cloud-security-comparison-1b182104c40e</li> <li>[ ] a bunch of youtube https://www.youtube.com/watch?v=7jUSFpsKj1E https://www.youtube.com/watch?v=WyGm28gHp3M https://www.youtube.com/watch?v=L5N9S8pKpOw</li> <li>[ ] sending logs https://www.youtube.com/watch?v=BLqNvaF5nXg</li> </ul>"},{"location":"microsoft-defender-suite/#azure-and-sentinel","title":"azure and sentinel","text":""},{"location":"microsoft-defender-suite/#xdr","title":"XDR","text":"<p>also see high level above</p> <p></p> <p>capabilities</p> <p>unified alert from various platform. deception in XDR</p>"},{"location":"microsoft-defender-suite/#mdi","title":"MDI","text":""},{"location":"microsoft-defender-suite/#what","title":"what","text":"<p>if you have domain controller, install MDI sensor. Defender for Identity uses data from across your environment, including domain controllers, Active Directory Federation Services (AD FS), and Active Directory Certificate services (AD CS), to provide you with a complete view of your identity environment.</p> <p>full list of alert here</p>"},{"location":"microsoft-defender-suite/#setup","title":"setup","text":"<p>from dcaddick prereq,  plan, sizing tool, service account, download and install sensor, last config.</p> <p>for adfs</p>"},{"location":"microsoft-defender-suite/#validate","title":"validate","text":"<p>select Settings &gt; Identities &gt; check if all DC have MDI sensors. validate sensor instlal common error: Directory Services Object Auditing is not configured as required: https://aka.ms/mdi/objectauditing</p>"},{"location":"microsoft-defender-suite/#work-with","title":"work with","text":"<p>how to investigate the alert and remediate aside from that also available reports</p>"},{"location":"microsoft-defender-suite/#improve","title":"improve","text":"<p>hardened MDI, and better your posture </p>"},{"location":"microsoft-defender-suite/#mde","title":"MDE","text":""},{"location":"microsoft-defender-suite/#what_1","title":"what","text":"<p>end point protection. aside from server</p>"},{"location":"microsoft-defender-suite/#setup_1","title":"setup","text":""},{"location":"microsoft-defender-suite/#prepare-mde","title":"prepare mde","text":"<ol> <li>Check license state: check license from azure portal license, or billing &gt; subscription</li> <li>Cloud Service Provider validation: check which license is provisioned and the state of the license. CSP is MS partner that help you when you buy MS product.</li> <li>Tenant Configuration: Initiate Microsoft Defender for Endpoint tenant</li> <li>Data center location: Microsoft Defender for Endpoint stores and process data in the\u00a0XDR</li> <li>Network configuration: follow the steps to ensure access to MDE</li> </ol> <p>good resource on MDE settings explanation and advice </p>"},{"location":"microsoft-defender-suite/#role-permission","title":"role &amp; permission","text":"<p>how to assign role is here and here. least privilege principles when assigning role.</p>"},{"location":"microsoft-defender-suite/#architecture-deployment-method","title":"architecture &amp; deployment method","text":"<p>Identify your architecture and choose your deployment method: Identify your architecture and the deployment method that best suits your organization. pdf guide  here  depends on how you are setup, below is the recommended deployment.  in short: use  Intune if you are cloud native. use config manager if you are hybrid or on-prem. or use a local script if you do not manage your device.</p> <p></p>"},{"location":"microsoft-defender-suite/#onboard-device","title":"onboard device","text":"<p>onboard device by first choosing method, use the ring approach method, based your previous step/ architecture. among others are Intune and config manager</p> <p>also deployment in linux</p>"},{"location":"microsoft-defender-suite/#validate_1","title":"validate","text":"<p>check it is working with scenarios and test with demo</p>"},{"location":"microsoft-defender-suite/#work-with_1","title":"work with","text":"<p>device discovery</p>"},{"location":"microsoft-defender-suite/#improve_1","title":"improve","text":"<p>set up automated investigation and response - AIR set up attack surface reduction rules (ASR rules), and see the report, improve upon it. see MDE device health report and fix unhealthy sensors see MDE device firewall report</p>"},{"location":"microsoft-defender-suite/#mdca","title":"MDCA","text":""},{"location":"microsoft-defender-suite/#what_2","title":"what","text":"<p>It's a Cloud Access Security Broker (CASB) solution. focuses on SaaS application security and user behaviors.</p>"},{"location":"microsoft-defender-suite/#setup_2","title":"setup","text":"<p>getting started MDCA</p> <ul> <li>prereq: you must at least be a Security Administrator in Microsoft Entra ID or Microsoft 365</li> <li>RBAC for admins needed? manage admin</li> <li>connect cloud apps</li> <li>set up DLP</li> <li>set up policy</li> <li>set up cloud discovery</li> <li>organize data with tags and IP address</li> <li>daily activities to increase posture</li> <li>best practice</li> </ul> <p>best practice</p> <p>dcaddick and microsoft</p> <ul> <li>Discover and assess cloud apps</li> <li>Apply cloud governance policies</li> <li>Limit exposure of shared data and enforce collaboration policies</li> <li>Discover, classify, label, and protect regulated and sensitive data stored in the cloud</li> <li>Enforce DLP and compliance policies for data stored in the cloud</li> <li>Block and protect download of sensitive data to unmanaged or risky devices</li> <li>Secure collaboration with external users by enforcing real-time session controls</li> <li>Detect cloud threats, compromised accounts, malicious insiders, and ransomware</li> <li>Use the audit trail of activities for forensic investigations</li> <li>Secure IaaS services and custom apps</li> </ul>"},{"location":"microsoft-defender-suite/#connect-apps","title":"connect apps","text":"<p>this is basically posture assessment using MDCA for SaaS. see also MDC (more appropriate for azure infra as opposed to SaaS)</p> <p>workflow: 1. Defender for Cloud Apps scans and saves authentication permissions. 2. Defender for Cloud Apps requests the user list. The first time the request is done, it may take some time until the scan completes. After the user scan is over, Defender for Cloud Apps moves on to activities and files. As soon as the scan starts, some activities will be available in Defender for Cloud Apps. 3. After completion of the user request, Defender for Cloud Apps periodically scans users, groups, activities, and files. All activities will be available after the first full scan.</p> <p>capabilities (depends on CSP): - Account information\u00a0- Visibility into users, accounts, profile information, status (suspended, active, disabled) groups, and privileges. - Audit trail\u00a0- Visibility into user activities, admin activities, sign-in activities. - Account governance\u00a0- Ability to suspend users, revoke passwords, etc. - App permissions\u00a0- Visibility into issued tokens and their permissions. - App permission governance\u00a0- Ability to remove tokens. - Data scan\u00a0- Scanning of unstructured data using two processes -periodically (every 12 hours) and in real-time scan (triggered each time a change is detected). - Data governance\u00a0- Ability to quarantine files, including files in trash, and overwrite files.</p> <p>how to here</p>"},{"location":"microsoft-defender-suite/#set-up-dlp","title":"set up dlp","text":"<p>read on file policies and purview below</p>"},{"location":"microsoft-defender-suite/#set-up-cloud-discovery","title":"set up cloud discovery","text":"<p>you can set up MDCA to discover apps, guide here</p> <p>Cloud discovery analyzes your traffic logs against the Microsoft Defender for Cloud Apps catalog of over 31,000 cloud apps. </p> <p>you can have snapshot (one time upload of your traffic to be analyzed) or continuous report (use log collector, connector or cloud API to continuously upload).</p>"},{"location":"microsoft-defender-suite/#set-up-policies","title":"set up policies","text":"<p>policy guide</p> <p>Policies allow you to define the way you want your users to behave in the cloud. If necessary, you can integrate remediation work flows to achieve complete risk mitigation. The following types of policies can be created:</p> Policy type icon Policy type Category Use Activity policy Threat detection Activity policies allow you to enforce a wide range of automated processes using the app provider's APIs. These policies enable you to monitor specific activities carried out by various users, or follow unexpectedly high rates of a certain type of activity.\u00a0Learn more Anomaly detection policy Threat detection Anomaly detection policies enable you to look for unusual activities on your cloud. Detection is based on the risk factors you set to alert you when something happens that is different from the baseline of your organization or from the user's regular activity.\u00a0Learn more OAuth app policy Threat detection OAuth app policies enable you to investigate which permissions each OAuth app requested and automatically approve or revoke it. These are built-in policies that come with Defender for Cloud Apps and can't be created.\u00a0Learn more Malware detection policy Threat detection Malware detection policies enable you to identify malicious files in your cloud storage and automatically approve or revoke it. This is a built-in policy that comes with Defender for Cloud Apps and can't be created.\u00a0Learn more File policy/ DLP Information protection File policies enable you to scan your cloud apps for specified files or file types (shared, shared with external domains), data (proprietary information, personal data, credit card information, and other types of data) and apply governance actions to the files (governance actions are cloud-app specific).\u00a0Learn more Access policy Conditional Access Access policies provide you with real-time monitoring and control over user logins to your cloud apps.\u00a0Learn more Session policy Conditional Access Session policies provide you with real-time monitoring and control over user activity in your cloud apps.\u00a0Learn more App discovery policy Shadow IT App discovery policies enable you to set alerts that notify you when new apps are detected within your organization.\u00a0Learn more ###### activity policy how to <ul> <li>To ensure that you only include results where the specified filter field has a value, we recommend adding the same field again using the\u00a0is set\u00a0test. For example, when filtering by\u00a0Location does not equal\u00a0a specified list of countries/regions, also add a filter for\u00a0Location is set. You can also preview the filter results by selecting\u00a0Edit and preview results.</li> <li>When a filter is set to\u00a0does not equal\u00a0and the attribute does not exist on the event, the event will not be filtered out. For example, filtering on\u00a0Device Tag does not equal Microsoft Entra hybrid joined\u00a0doesn't filter out events that do not contain\u00a0Device tag, even if the device is Microsoft Entra joined.</li> <li>In case of a guest user, there may be cases where the\u00a0User From Group\u00a0filter doesn't recognize the account by its domain. To make sure all guest users are included, use the\u00a0External users\u00a0as the group, if it meets your needs for the policy.</li> </ul>"},{"location":"microsoft-defender-suite/#file-policy","title":"file policy","text":"<p>how to You are limited to 50 file policies in Defender for Cloud Apps. also read common data protection policy</p> <p>best practice 1. Avoid resetting the file policy (by using the\u00a0Reset results and apply actions again\u00a0checkbox) in production environments unless it's absolutely necessary, as doing so will initiate a full scan of the files covered by the policy, which can have a negative impact on its performance. 2. When applying labels to files in a specific parent folder\u00a0and\u00a0its subfolders, use the\u00a0Apply to\u00a0-&gt;\u00a0Selected folders\u00a0option. Then add each of the parent folders. 3. When applying labels to files in a specific folder only (excluding any subfolders), use the file policy filter\u00a0Parent Folder\u00a0with the\u00a0Equals\u00a0operator. 4. File policy is faster when narrow filtering criteria are used (as compared to wide criteria). 5. Consolidate several file policies for the same service (such as SharePoint, OneDrive, Box, and so on) to a single policy. 6. When enabling file monitoring (from the\u00a0Settings\u00a0page), create at least one file policy. When no file policy exists, or is disabled for seven consecutive days, file monitoring is autodisabled.</p>"},{"location":"microsoft-defender-suite/#integrating-with-other-services","title":"integrating with other services","text":""},{"location":"microsoft-defender-suite/#purview","title":"purview","text":"<p>Microsoft Defender for Cloud Apps lets you automatically apply sensitivity labels from Microsoft Purview. These labels are applied to files as a file policy governance action, and depending on the label configuration, can apply encryption for additional protection. You can also investigate files by filtering for the applied sensitivity label within Defender for Cloud Apps. Using labels enables greater visibility and control of your sensitive data in the cloud. how to</p> <p>prerequisite  - a Defender for Cloud Apps license and a license for Microsoft Purview.  - To work with Microsoft Purview integration, you must enable the\u00a0App connector for Microsoft 365.</p>"},{"location":"microsoft-defender-suite/#mde_1","title":"MDE","text":"<p>summary: function as detect and protect for shadow IT/ unsanction app access through end point telemetry sent by MDE. prerequisite: MDCA and MDE license</p> <p>how it work:  detect - endpoint log sent to MDCA (device/user info, traffic) - check risky device/ user -&gt; pivot using that user/ device or detected app - investigate and govern protect govern via MDE</p> <p>how to: guide here</p>"},{"location":"microsoft-defender-suite/#mdi_1","title":"MDI","text":"<p>guide and capabilities here</p>"},{"location":"microsoft-defender-suite/#work-with_2","title":"work with","text":"<p>investigate threat investigate dashboard tune sus action risky oauth MDE investigation discover and govern Gen AI app:  - The cloud app catalog now contains hundreds of new Generative AI apps that enable security teams to discover and understand the risk associated with each app. - Configure policies to automatically trigger alerts when new Generative AI apps are used within your organization. - For organizations using Defender for Endpoint integration, apps tagged as \u201cunsanctioned\u201d will be instantly blocked on onboarded devices. govern gen AI tutorial: youtube</p>"},{"location":"microsoft-defender-suite/#improve_2","title":"improve","text":"<p>Investigate Apps discovered by MDE\u00a0https://learn.microsoft.com/en-us/defender-cloud-apps/mde-investigation</p> <p>Governance for Connected Apps\u00a0https://learn.microsoft.com/en-us/defender-cloud-apps/governance-actions </p> <p>Governance for discovered Apps\u00a0https://learn.microsoft.com/en-us/defender-cloud-apps/governance-discovery\u00a0Now we can take this one step further and we can now determine which of the 26,000 SaaS Apps I want to allow or block - the only real limitation (to a certain extent) is that the user is using corporate credentials from our AAD via an endpoint enabled with MDE</p> <p>use it with gen AI</p>"},{"location":"microsoft-defender-suite/#office-365-cloud-app-security-vs-mdca","title":"office 365 cloud app security vs MDCA","text":"<p>Office 365 Cloud App Security is a subset of Microsoft Defender for Cloud Apps that provides enhanced visibility and control for Office 365. source</p> Capability Feature Microsoft Defender for Cloud Apps Office 365 Cloud App Security Cloud discovery Discovered apps 31,000 + cloud apps 750+ cloud apps with similar functionality to Office 365 Deployment for discovery analysis - Manual upload   - Automated upload - Log collector and API   - Native Defender for Endpoint integration Manual log upload Log anonymization for user privacy Yes Access to full cloud app catalog Yes Cloud app risk assessment Yes Cloud usage analytics per app, user, IP address Yes Ongoing analytics &amp; reporting Yes Anomaly detection for discovered apps Yes Information Protection Data Loss Prevention (DLP) support Cross-SaaS DLP and data sharing control Uses existing Office DLP (available in Office E3 and above) App permissions and ability to revoke access Yes Yes Policy setting and enforcement Yes Integration with Microsoft Purview Yes Integration with third-party DLP solutions Yes Threat Detection Anomaly detection and behavioral analytics For Cross-SaaS apps including Office 365 For Office 365 apps Manual and automatic alert remediation Yes Yes SIEM connector Yes. Alerts and activity logs for cross-SaaS apps. For Office 365 alerts only Integration to Microsoft Intelligent Security Graph Yes Yes Activity policies Yes Yes Conditional access app control Real-time session monitoring and control Any cloud and on-premises app For Office 365 apps Cloud Platform Security Security configurations For Azure, AWS, and GCP For Azure ### MDO <p>Defender for Office</p>"},{"location":"microsoft-defender-suite/#mip","title":"MIP","text":"<p>microsoft information protection</p> <p>guides here</p>"},{"location":"microsoft-defender-suite/#graph-query-grap-api-azure-graph","title":"graph query, grap api, azure graph","text":""},{"location":"microsoft-defender-suite/#so-many-graph","title":"so many graph","text":"<p>Azure Resource Graph: Azure Resource Graph\u00a0- This is used for\u00a0querying resources that exist in Microsoft Azure, and their basic properties GraphQL\u00a0- GraphQL is an open source language used in applications for communication between the client and the server Microsoft Graph Security API\u00a0- This is just one of the underlying APIs that targets a particular service via the Microsoft Graph,</p>"},{"location":"microsoft-defender-suite/#microsoft-cybersecurity-reference-architecture","title":"Microsoft Cybersecurity Reference Architecture","text":"<p>these are from MCRA</p>"},{"location":"microsoft-defender-suite/#adopting-principles","title":"adopting principles","text":"<ul> <li>End to End Security: Consider the whole problem</li> <li>Ruthlessly Prioritize: Identify top gaps + quick wins</li> <li>Get started: Start somewhere &amp; continuously improve</li> </ul>"},{"location":"microsoft-defender-suite/#sentinel-data-lake","title":"sentinel data lake","text":"<p>https://learn.microsoft.com/en-us/azure/sentinel/best-practices-data</p>"},{"location":"microsoft-defender-suite/#purview_1","title":"purview","text":"<p>purview DLP insider risk ediscovery</p> <p>https://setup.cloud.microsoft/purview</p>"},{"location":"microsoft-defender-suite/#o365-security","title":"o365 security","text":"<p>https://learn.microsoft.com/en-us/microsoft-365/security/security-posture-solution-overview?view=o365-worldwide</p> <p>https://www.youtube.com/watch?v=y7m-X8AGBlM</p>"},{"location":"microsoft-defender-suite/#licensing-and-feature","title":"licensing and feature","text":"<p>m365map and m365matrix</p> <p>https://infusedinnovations.com/blog/secure-modern-workplace/complete-office-365-and-microsoft-365-licensing-comparison</p>"},{"location":"microsoft-defender-suite/#logs","title":"logs","text":"<p>expand here </p> <p>Unified Audit Log (UAL) - The backbone of forensic investigations in Microsoft 365, capturing activity across Exchange, SharePoint, Teams, and more. \u2192 Sign-in &amp; Audit Logs - Essential for tracking account takeovers, MFA bypass attempts, and privilege escalation. Defender for Office 365 - Analyzing phishing, email delivery, and malicious attachments. Defender XDR - Mapping user behavior, anomalies, and lateral movement.</p>"},{"location":"microsoft-defender-suite/#aws-security","title":"aws security","text":""},{"location":"microsoft-defender-suite/#native-aws-stuff","title":"native aws stuff","text":""},{"location":"microsoft-defender-suite/#cloudtrail","title":"cloudtrail","text":""},{"location":"microsoft-defender-suite/#guardduty","title":"guardduty","text":""},{"location":"microsoft-defender-suite/#security-hub","title":"security hub","text":""},{"location":"microsoft-defender-suite/#tooling-for-aws-security","title":"tooling for aws security","text":""},{"location":"microsoft-defender-suite/#prowler","title":"prowler","text":""},{"location":"microsoft-defender-suite/#steampipe","title":"steampipe","text":""},{"location":"microsoft-defender-suite/#xsiam","title":"XSIAM","text":"<p>https://www.youtube.com/watch?v=wqXsCMc5lzQ&amp;list=PLBpoVs10QWXI_gjH5_gNAFDhl_dDwE0oR&amp;index=1</p>"},{"location":"microsoft-defender-suite/#reference-and-related","title":"reference-and-related","text":"<p>infosec-compendiums marks list GSD -&gt; very good and complete steps jeffreyappel blog ms. entra and ms. purview</p>"},{"location":"microsoft-entra/","title":"about","text":""},{"location":"microsoft-entra/#entra-id","title":"entra id","text":"<p>entra id (Azure AD) is the central \u201cdirectory store\u201d containing all objects and resources (e.g., user accounts, managed identities, applications subscriptions, etc.) used by tenants</p>"},{"location":"microsoft-entra/#roles","title":"roles","text":"<p>Entra ID offers a wide range of permissions and simplifies their assignment by grouping them into roles. Microsoft provides various Microsoft Entra roles to streamline this process.   As of today, there are\u00a0118 built-in roles. Microsoft is constantly improving its services. The number of roles might differ between your tenant and other tenants!</p> <p>You can find all roles in the Entra admin center by following\u00a0this link.</p> <p>or use this graph script</p> <pre><code># connect to Microsoft Graph\nConnect-MgGraph -ContextScope process -Scopes RoleManagement.Read.Directory -NoWelcome\n\n# count the number of roles\n(Get-MgRoleManagementDirectoryRoleDefinition | measure-object).count\n\n# display roles sorted by DisplayName\nGet-MgRoleManagementDirectoryRoleDefinition | sort-object DisplayName\n\n# store all roles in a variable\n[array]$Roles=Get-MgRoleManagementDirectoryRoleDefinition\n\n# show details for a role. The first one as an example\n$Roles[0] | Format-List * -Force\n\n# use the roleDefinitionID to retrieve all assigned permissions\nGet-MgRoleManagementDirectoryRoleDefinitionInheritPermissionFrom -UnifiedRoleDefinitionId 62e90394-69f5-4237-9190-012177145e10 |\n Select-Object -ExpandProperty RolePermissions |\n Select-Object -ExpandProperty AllowedResourceActions\n</code></pre> <p>Note: To run the code above, you must connect to Microsoft Graph with at least\u00a0RoleManagement.Read.Directory\u00a0scope as outlined\u00a0here.</p>"},{"location":"microsoft-entra/#roles-categories","title":"roles categories","text":"<p>Microsoft refers to \u201cthree broad categories\u201d of roles:</p> <ul> <li>Microsoft Entra ID-specific roles: permissions granted\u00a0only\u00a0in\u00a0Entra ID</li> <li>Service-specific roles in Microsoft Entra ID: permissions granted in\u00a0Entra ID\u00a0and a workload like\u00a0Exchange Online\u00a0or\u00a0SharePoint Online</li> <li>Cross-service roles in Microsoft Entra ID: these roles have been granted permissions across multiple workloads</li> </ul> <p>example in exchange</p> <p></p>"},{"location":"microsoft-entra/#role-assignment","title":"role assignment","text":"<ul> <li>Roles in Entra ID can be assigned in various ways; the simplest method is using the \"Add assignments\" option to directly assign users or groups to a role.</li> <li>Roles can also be assigned to \"Enterprise Applications,\" requiring the Object ID found under \"Enterprise Applications,\" as assignments are linked to the service principal, not the app itself. The reason why is that the assignment is to the service principal for an app instead of the app itself. Both enterprise apps and registered apps use service principals to hold role assignments. </li> </ul> <p> - Assignments made in this manner are permanent and remain until removed by an administrator. - It is recommended to limit role assignments to \"Enterprise Applications\" to avoid over-permissioning and excessive privileges for registered apps. - For assigning administrative roles to user accounts, tools like Privileged Identity Management or Entitlement Management should be utilized. - Future discussions will cover custom RBAC roles and Administrative Units in Entra ID.</p>"},{"location":"microsoft-entra/#reference-and-related","title":"reference-and-related","text":"<p>infosec-compendiums defender suite practical 365</p>"},{"location":"rds-log/","title":"Related notes and references","text":"<p>[[aws-detect-and-response]]</p>"},{"location":"rds-log/#rds-log","title":"RDS log","text":"<p>Amazon RDS (Relational Database Service) has supported its own intel instance level logging for some time now, but it also has the additional capability to have those logs fed into CloudWatch.</p>"},{"location":"rds-log/#what-does-it-log","title":"What does it log?","text":"<p>[[How to be IR Prepared in AWS - Cado Security  Cloud Forensics &amp; Incident Response#RDS]] RDS instance level-logs record general, error, audit, and slow query database events.</p> <p>Where does it log to?[[How to be IR Prepared in AWS - Cado Security  Cloud Forensics &amp; Incident Response#RDS]] RDS logs are stored internal to the RDS service but it can be optionally configured to send the logs to CloudWatch.</p> <p>How do I enable it?[[How to be IR Prepared in AWS - Cado Security  Cloud Forensics &amp; Incident Response#RDS]] RDS logs are enabled by default, but the CloudWatch integration needs to be manually configured. To do this: - Open the Amazon RDS console at https://console.aws.amazon.com/rds/. - Go to Databases, and choose the DB instance that you want to modify. - In the Log exports section, choose the logs that you want to start publishing to CloudWatch Logs. - Choose Continue, and then choose Modify DB Instance on the summary page.</p> <p>How do I access the logs?[[How to be IR Prepared in AWS - Cado Security  Cloud Forensics &amp; Incident Response#RDS]] The Internal RDS service logs are accessible via the RDS console or API. If the CloudWatch integration is enabled, then logs can also be viewed in the CloudWatch dashboard.</p>"},{"location":"threat-modelling/","title":"Threat Modelling","text":"","tags":["threat-model"]},{"location":"threat-modelling/#threat-model-summary","title":"Threat Model Summary","text":"<p>[!info] Threat Modeling\u200a\u2014\u200aThe Short Version Threat Modeling is the structured practice of identifying and prioritizing potential threats and vulnerabilities, and the prioritization\u2026 http://medium.com/dark-roast-security/threat-modeling-the-short-version-5b70ba96cea8?utm_source=pocket_shared </p> <p>[!important] STRIDE Spoofing, Tampering, Repudiation, Information Disclosure, Denial of Service (DoS), and Elevation of privilege (STRIDE) was developed by Microsoft with the goal to aid applications in meeting security standards based on the CIA triad principles: Confidentiality, Integrity, and Availability. STRIDE offers a six-category process to identify security threats, shown below.</p> <p>[!important] VAST The Visual, Agile, and Simple Threat (VAST) Model is a method based on ThreatModeler which is an automated threat modeling platform. The VAST threat modeling focuses on covering the entire software development lifecycle (SDLC) across an organization.</p> <p>[!important] OCTAVE The Operationally Critical Threat, Asset, and Vulnerability Evaluation (OCTAVE) process is a risk-based strategic assessment and planning method that focuses on assessing organizational risks with little to no focus on technological risks. OCTAVE has three phases: Build asset-based threat profiles. Identify infrastructure vulnerability. Develop a security strategy and plans.  </p> <p>[!important] PASTA The Process for Stack Simulation and Threat Analysis (PASTA) is a risk-centric threat modeling framework that aims to bring business objectives and technical requirements together. PASTA employs an attacker-centric perspective to produce an asset-focused output in the form of threat enumeration and scoring.</p> <p>[!important] DREAD The DREAD methodology was proposed by Microsoft and published in 2008. It is currently used by many organizations to assess the probability of security risks within five categories:</p> <p>[!important] TRIKE Trike, was created as a security audit framework \u2014 it focuses on using threat models as a risk management tool. By using the requirements model, each asset is assigned an acceptable risk level. The analysis of requirements models yields a threat model where potential threats are identified and given risk values. Lastly, the appropriate security controls are assigned to each asset until the risk that the threats posed to each asset is within the tolerable range that the requirement model outlines. The completed threat model is then used to build a risk model, factoring in actions, assets, roles, and calculated risk exposure.</p> <p>[!important] MITRE ATT&amp;CK MITRE ATT&amp;CK is a \u201cglobally-accessible knowledge base of adversary tactics and techniques based on real-world observations.\u201d This framework is used in the development of threat models by providing a detailed outline of common techniques used by cybercriminals to compromise businesses and organizations.</p> <p>[!important] CVSS The Common Vulnerability Scoring System (CVSS) method was developed by NIST and captures a vulnerability\u2019s main characteristics, then assigns a numerical score which is then translated to a severity score. This representation helps organizations effectively assess and prioritize the vulnerabilities that exist in their environment.</p>","tags":["threat-model"]}]}